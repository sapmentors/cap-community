/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/Context","sap/ui/model/ContextBinding","sap/ui/model/ChangeReason","sap/ui/thirdparty/jquery"],function(e,t,i,n){"use strict";var o=t.extend("sap.ui.model.odata.v2.ODataContextBinding",{constructor:function(e,i,o,s,r){t.call(this,e,i,o,s,r);this.sRefreshGroupId=undefined;this.bPendingRequest=false;this.mParameters=n.extend(true,{},this.mParameters);this.bCreatePreliminaryContext=this.mParameters.createPreliminaryContext||e.bPreliminaryContext;this.bUsePreliminaryContext=this.mParameters.usePreliminaryContext||e.bPreliminaryContext;this.mParameters.createPreliminaryContext=this.bCreatePreliminaryContext;this.mParameters.usePreliminaryContext=this.bUsePreliminaryContext;this.bPendingRequest=false}});o.prototype.initialize=function(){var t=this,n,o=this.isRelative()&&this.oContext&&this.oContext.bCreated,s=this.oContext&&this.oContext.isPreliminary(),r;if(!this.oModel.oMetadata.isLoaded()||!this.bInitial){return}this.bInitial=false;if(s&&!this.bUsePreliminaryContext){return}n=this.oModel.resolve(this.sPath,this.oContext);if(!n||o){this.oElementContext=null;this._fireChange({reason:i.Context});return}r=this.oModel._isReloadNeeded(n,this.mParameters);if(r){this.fireDataRequested();this.bPendingRequest=true}var a=this.oModel.createBindingContext(this.sPath,this.oContext,this.mParameters,function(n){var o,s=n&&n.isUpdated(),a=n&&n.isRefreshForced();if(t.bCreatePreliminaryContext&&n&&t.oElementContext){t.oElementContext.setPreliminary(false);t.oModel._updateContext(t.oElementContext,n.getPath());t._fireChange({reason:i.Context},false,true)}else if(!n||e.hasChanged(n,t.oElementContext)){t.oElementContext=n;t._fireChange({reason:i.Context},a,s)}if(r){if(t.oElementContext){o=t.oElementContext.getObject(t.mParameters)}t.oModel.callAfterUpdate(function(){t.fireDataReceived({data:o})});t.bPendingRequest=false}},r);if(a){if(this.bCreatePreliminaryContext&&this.oElementContext!==a){a.setPreliminary(true);this.oElementContext=a;this.oModel.oMetadata.loaded().then(function(){this._fireChange({reason:i.Context})}.bind(this))}}else if(this.oContext){this.oElementContext=null;this._fireChange({reason:i.Context})}};o.prototype.checkUpdate=function(e){var t,o=this.oContext&&this.oContext.isPreliminary();if(this.bInitial||this.bPendingRequest){return}if(this.oContext&&this.oContext.isUpdated()){this.setContext(this.oContext);return}if(o&&!this.bUsePreliminaryContext){return}if(!this._mParameters&&this.mParameters.createPreliminaryContext){this._mParameters=n.extend({},this.mParameters);delete this._mParameters.usePreliminaryContext;delete this._mParameters.createPreliminaryContext}t=this.oModel.createBindingContext(this.sPath,this.oContext,this._mParameters);if(t!==undefined&&t!==this.oElementContext){this.oElementContext=t;this._fireChange({reason:i.Context})}};o.prototype.refresh=function(e,t){if(typeof e==="string"){t=e;e=false}this.sRefreshGroupId=t;this._refresh(e);this.sRefreshGroupId=undefined};o.prototype._refresh=function(t,o){var s=this,r,a,h,l=false,C=this.mParameters,x=this.isRelative()&&this.oContext&&this.oContext.bCreated,m=this.oModel.resolve(this.sPath,this.oContext),f;if(this.bInitial||x){return}if(o){h=this.oModel._getObject(this.sPath,this.oContext);if(h){a=this.oModel._getKey(h);if(a in o){l=true}}}else{l=true}if(t||l){if(m){this.fireDataRequested();this.bPendingRequest=true}if(this.sRefreshGroupId){C=n.extend({},this.mParameters);C.groupId=this.sRefreshGroupId}var d=this.oModel.createBindingContext(this.sPath,this.oContext,C,function(n){if(s.bCreatePreliminaryContext&&n&&s.oElementContext){s.oElementContext.setPreliminary(false);s.oModel._updateContext(s.oElementContext,n.getPath());s._fireChange({reason:i.Context},false,true)}else if(e.hasChanged(n,s.oElementContext)||t){s.oElementContext=n;s._fireChange({reason:i.Context},t)}if(s.oElementContext){r=s.oElementContext.getObject(s.mParameters)}if(m){s.oModel.callAfterUpdate(function(){s.fireDataReceived({data:r})});s.bPendingRequest=false}},true);if(d&&this.bCreatePreliminaryContext){if(this.oElementContext!==d||t){d.setPreliminary(true);this.oElementContext=d;f=this.oElementContext.sPath;this.oModel._updateContext(this.oElementContext,m);this._fireChange({reason:i.Context},t);this.oModel._updateContext(this.oElementContext,f)}}}};o.prototype.setContext=function(t){var n=this,o,s,r=t&&t.bCreated,a=t&&t.isPreliminary(),h=t&&t.isRefreshForced(),l=t&&t.isUpdated(),C,x;if(this.bInitial||!this.isRelative()){return}if(a&&!this.bUsePreliminaryContext){return}if(l&&this.bUsePreliminaryContext){this._fireChange({reason:i.Context});return}if(e.hasChanged(this.oContext,t)){this.oContext=t;s=this.oModel.resolve(this.sPath,this.oContext);if(!s||r){if(this.oElementContext!==null){this.oElementContext=null;this._fireChange({reason:i.Context})}return}o=this.oModel._getObject(this.sPath,this.oContext);x=h||this.oModel._isReloadNeeded(s,this.mParameters);if(s&&x){this.fireDataRequested();this.bPendingRequest=true}var t=this.oModel.createBindingContext(this.sPath,this.oContext,this.mParameters,function(t){if(n.bCreatePreliminaryContext&&t&&n.oElementContext){n.oElementContext.setPreliminary(false);n.oModel._updateContext(n.oElementContext,t.getPath());n._fireChange({reason:i.Context},false,true)}else if(e.hasChanged(t,n.oElementContext)){n.oElementContext=t;n._fireChange({reason:i.Context},h,l)}if(s&&x){if(n.oElementContext){o=n.oElementContext.getObject(n.mParameters)}n.oModel.callAfterUpdate(function(){n.fireDataReceived({data:o})});n.bPendingRequest=false}},x);if(t){if(this.bCreatePreliminaryContext){t.setPreliminary(true);this.oElementContext=t;C=this.oElementContext.sPath;this.oModel._updateContext(this.oElementContext,s);this._fireChange({reason:i.Context},h);this.oModel._updateContext(this.oElementContext,C)}}else if(this.oContext&&this.oElementContext!==null){this.oElementContext=null;this._fireChange({reason:i.Context})}}};o.prototype._fireChange=function(e,i,n){if(this.oElementContext){this.oElementContext.setForceRefresh(i);this.oElementContext.setUpdated(n)}t.prototype._fireChange.call(this,e);if(this.oElementContext){this.oElementContext.setForceRefresh(false);this.oElementContext.setUpdated(false)}};return o});