/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/Filter","sap/ui/model/TreeBinding","sap/ui/model/odata/v2/ODataTreeBinding","sap/ui/model/ChangeReason","sap/ui/model/TreeBindingUtils","sap/base/util/uid","sap/base/Log","sap/base/assert","sap/ui/thirdparty/jquery","sap/base/util/isEmptyObject"],function(e,t,i,n,r,o,a,s,d,l){"use strict";var h=function(){if(!(this instanceof t)||this._bIsAdapted){return}for(var e in h.prototype){if(h.prototype.hasOwnProperty(e)){this[e]=h.prototype[e]}}this.mParameters=this.mParameters||{};this._iPageSize=0;this._aNodes=this._aNodes||[];this._aNodeCache=[];this._aCollapsed=this._aCollapsed||[];this._aExpanded=this._aExpanded||[];this._aRemoved=[];this._aAdded=[];this._aNodeChanges=[];this._aAllChangedNodes=[];this._mSubtreeHandles={};this._iLowestServerLevel=null;this._aExpandedAfterSelectAll=this._aExpandedAfterSelectAll||[];this._mSelected=this._mSelected||{};this._mDeselected=this._mDeselected||{};this._bSelectAll=false;this._iLengthDelta=0;if(this.mParameters.collapseRecursive===undefined){this.bCollapseRecursive=true}else{this.bCollapseRecursive=!!this.mParameters.collapseRecursive}this._bIsAdapted=true;this._bReadOnly=true;this._aPendingRequests=[];this._aPendingChildrenRequests=[];this._aPendingSubtreeRequests=[]};h.prototype.setNumberOfExpandedLevels=function(e){this.resetData();i.prototype.setNumberOfExpandedLevels.apply(this,arguments)};h.prototype.getContexts=function(e,t,i,n){if(this.isInitial()){return[]}e=e||0;t=t||this.oModel.iSizeLimit;i=i||0;this._iPageSize=t;this._iThreshold=i;if(this._aNodes.length==0&&!this.isLengthFinal()){this._loadData(e,t,i)}var r=[];var o=this._retrieveNodeSection(e,t);this._aNodeCache=[];var a;var s=0;var d=0;var l={};for(var h=0;h<o.length;h++){var u=o[h];this._aNodeCache[e+h]=u&&u.context?u:undefined;r.push(u.context);if(!u.context){if(u.serverIndex!=undefined){if(a==undefined){a=u.serverIndex}d=u.serverIndex}else if(u.positionInParent!=undefined){var f=u.parent;l[f.key]=l[f.key]||[];l[f.key].push(u)}}}s=1+Math.max(d-(a||0),0);if(a!=undefined&&s){this._loadData(a,s,i)}for(var p in l){var c=this._calculateRequestParameters(l[p]);this._loadChildren(l[p][0].parent,c.skip,c.top)}if(n){return o}else{return r}};h.prototype._calculateRequestParameters=function(e){var t=e[0].parent;var i=e[0].positionInParent;var n=Math.min(i+Math.max(this._iThreshold,e.length),t.children.length);for(var r=i;r<n;r++){var o=t.children[r];if(o){break}}return{skip:i,top:r-i}};h.prototype._retrieveNodeSection=function(e,t){return this._bReadOnly?this._indexRetrieveNodeSection(e,t):this._mapRetrieveNodeSection(e,t)};h.prototype._mapRetrieveNodeSection=function(e,t){var i=-1;var n=[];this._map(function(r,o,a,s,d){i++;if(i>=e){if(!r){if(a=="serverIndex"){r={serverIndex:s}}else if(a=="positionInParent"){r={positionInParent:s,parent:d}}}n.push(r)}if(n.length>=t){o.broken=true}});return n};h.prototype._indexRetrieveNodeSection=function(e,t){var i,n=[],r,o;for(i=e;i<e+t;i++){r=this.getNodeInfoByRowIndex(i);if(r.index!==undefined&&r.index<this._aNodes.length){o=this._aNodes[r.index];if(!o){o={serverIndex:r.index}}}else if(r.parent){o=r.parent.children[r.childIndex];if(!o){o={parent:r.parent,positionInParent:r.childIndex}}}if(o){n.push(o);o=null}}return n};h.prototype.getNodes=function(e,t,i){var n=this.getContexts(e,t,i,true);return n};h.prototype._map=function(e){var t={broken:false};var i=function(e){if(e.addedSubtrees.length>0&&!e.nodeState.collapsed){for(var i=0;i<e.addedSubtrees.length;i++){var r=e.addedSubtrees[i];n(e,r);if(t.broken){return}}}};var n=function(e,t){var i=t._getSubtree();if(t){if(Array.isArray(i)){if(t._oSubtreeRoot){o(i,t._oSubtreeRoot.serverIndex,t._oSubtreeRoot,t._oSubtreeRoot.originalLevel||0,e.level+1)}else{o(i,null,null,0,e.level+1)}}else{t._oSubtreeRoot.level=e.level+1;r(t._oSubtreeRoot,false,t._oNewParentNode,-1,t._oSubtreeRoot)}}};var r=function(n,o,a,s,d){if(!o){if(!n.nodeState.removed||d==n){e(n,t,"positionInParent",s,a);if(t.broken){return}}}i(n);if(t.broken){return}if(n&&n.children&&n.nodeState.expanded){for(var l=0;l<n.children.length;l++){var h=n.children[l];if(h&&!h.nodeState.removed&&!h.nodeState.reinserted){h.level=n.level+1}if(h&&!h.nodeState.removed){r(h,false,n,l,d)}else if(!h){e(h,t,"positionInParent",l,n)}if(t.broken){return}}}};var o=function(n,o,a,s,d){for(var l=0;l<n.length;l++){var h=n[l];if(h&&h.nodeState&&h.nodeState.removed&&h!=a){if(!h.initiallyCollapsed){l+=h.magnitude}continue}if(h&&s>=0&&d>=0){h.level=h.originalLevel||0;var u=h.level-s||0;h.level=d+u||0}if(o===null){e(h,t,"newNode")}else{e(h,t,"serverIndex",o+l)}if(t.broken){return}if(h&&h.nodeState){if(!h.initiallyCollapsed&&h.nodeState.collapsed){l+=h.magnitude}else{if(h.initiallyCollapsed&&h.nodeState.expanded){r(h,true);if(t.broken){return}}else if(!h.initiallyCollapsed&&h.nodeState.expanded){i(h)}}}if(t.broken){return}}};o(this._aNodes,0,null)};h.prototype._loadData=function(e,t,i){var r=this;this.fireDataRequested();return this._requestServerIndexNodes(e,t,i).then(function(e){r._addServerIndexNodes(e.oData,e.iSkip);r._fireChange({reason:n.Change});r.fireDataReceived({data:e.oData})},function(e){var t=e.statusCode===0;if(!t){r._aNodes=[];r._bLengthFinal=true;r._fireChange({reason:n.Change})}r.fireDataReceived()})};h.prototype._restoreServerIndexNodes=function(e,t,i){var n=this;return this._requestServerIndexNodes(e,t,0,i).then(function(e){n._addServerIndexNodes(e.oData,e.iSkip);return e})};h.prototype._addServerIndexNodes=function(e,t){var i,n,r,o,s=function(e,t){if(!e.isDeepOne&&!e.initiallyCollapsed&&e.serverIndex<r&&e.serverIndex+e.magnitude>=r){return true}};if(!this._bLengthFinal){var d=e.__count?parseInt(e.__count):0;this._aNodes[d-1]=undefined;this._bLengthFinal=true}if(e.results&&e.results.length>0){for(o=0;o<e.results.length;o++){i=e.results[o];n=this.oModel.getKey(i);r=t+o;var l=i[this.oTreeProperties["hierarchy-node-descendant-count-for"]];if(l<0){l=0;a.error("The entry data with key '"+n+"' under binding path '"+this.getPath()+"' has a negative 'hierarchy-node-descendant-count-for' which isn't allowed.")}var h=this._aNodes[r]=this._aNodes[r]||{key:n,context:this.oModel.getContext("/"+n),magnitude:l,level:i[this.oTreeProperties["hierarchy-level-for"]],originalLevel:i[this.oTreeProperties["hierarchy-level-for"]],initiallyCollapsed:i[this.oTreeProperties["hierarchy-drill-state-for"]]==="collapsed",nodeState:{isLeaf:i[this.oTreeProperties["hierarchy-drill-state-for"]]==="leaf",expanded:i[this.oTreeProperties["hierarchy-drill-state-for"]]==="expanded",collapsed:i[this.oTreeProperties["hierarchy-drill-state-for"]]==="collapsed",selected:this._mSelected[n]?this._mSelected[n].nodeState.selected:false},children:[],addedSubtrees:[],serverIndex:r,parent:null,isDeepOne:false};if(this._iLowestServerLevel===null){this._iLowestServerLevel=h.level}else{this._iLowestServerLevel=Math.min(this._iLowestServerLevel,h.level)}if(this._bSelectAll){if(!this._aExpandedAfterSelectAll.some(s)){this.setNodeSelection(h,true)}}}}};h.prototype._requestServerIndexNodes=function(t,i,n,o){return new Promise(function(a,s){var d={iSkip:t,iTop:i+(n||0),iThreshold:n};this._aPendingRequests.sort(function(e,t){return e.iSkip-t.iSkip});for(var l=0;l<this._aPendingRequests.length;l++){if(r._determineRequestDelta(d,this._aPendingRequests[l])===false){return}}t=d.iSkip;i=d.iTop;function h(e){var n=this._aPendingRequests.indexOf(d);this._aPendingRequests.splice(n,1);a({oData:e,iSkip:t,iTop:i})}function u(e){var t=this._aPendingRequests.indexOf(d);this._aPendingRequests.splice(t,1);s(e)}var f=["$skip="+t,"$top="+i];if(!this._bLengthFinal||o){f.push("$inlinecount=allpages")}if(this.sCustomParams){f.push(this.sCustomParams)}var p=new e(this.oTreeProperties["hierarchy-level-for"],"LE",this.getNumberOfExpandedLevels());var c=[p];if(this.aApplicationFilters){c=c.concat(this.aApplicationFilters)}var v=this.oModel.resolve(this.getPath(),this.getContext());if(v){d.oRequestHandle=this.oModel.read(v,{urlParameters:f,filters:[new e({filters:c,and:true})],sorters:this.aSorters||[],success:h.bind(this),error:u.bind(this),groupId:this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId});this._aPendingRequests.push(d)}}.bind(this))};h.prototype._propagateMagnitudeChange=function(e,t){while(e!=null&&(e.initiallyCollapsed||e.isDeepOne)){e.magnitude+=t;if(!e.nodeState.expanded){return}e=e.parent}};h.prototype._getInitialMagnitude=function(e){var t=0,i;if(e.isDeepOne){return 0}if(e.children){for(var n=0;n<e.children.length;n++){i=e.children[n];t+=i.magnitude+1}}return e.magnitude-t};h.prototype._loadChildren=function(e,t,i){var r=this;this.fireDataRequested();this._requestChildren(e,t,i).then(function(t){r._addChildNodes(t.oData,e,t.iSkip);r._fireChange({reason:n.Change});r.fireDataReceived({data:t.oData})},function(t){var i=t.statusCode===0;if(!i){if(e.childCount===undefined){e.children=[];e.childCount=0;r._fireChange({reason:n.Change})}}r.fireDataReceived()})};h.prototype._restoreChildren=function(e,t,i){var n=this,r=e.context.getProperty(this.oTreeProperties["hierarchy-node-for"]);return this._requestChildren(e,t,i,true).then(function(e){var t;n._map(function(e,i){if(e&&e.context.getProperty(n.oTreeProperties["hierarchy-node-for"])===r){t=e;i.broken=true}});if(t){n._addChildNodes(e.oData,t,e.iSkip);n.expand(t,true)}return e})};h.prototype._addChildNodes=function(e,t,i){if(t.childCount==undefined&&e&&e.__count){var n=e.__count?parseInt(e.__count):0;t.childCount=n;t.children[n-1]=undefined;if(t.nodeState.expanded){this._propagateMagnitudeChange(t,n)}else{t.magnitude=n}this._cleanTreeStateMaps()}if(e.results&&e.results.length>0){for(var r=0;r<e.results.length;r++){var o=e.results[r];this._createChildNode(o,t,i+r)}}};h.prototype._createChildNode=function(e,t,i){var n=this.oModel.getKey(e);var r;if(t.containingServerIndex!==undefined){r=t.containingServerIndex}else{r=t.serverIndex}var o=t.children[i]=t.children[i]||{key:n,context:this.oModel.getContext("/"+n),magnitude:0,level:t.level+1,originalLevel:t.level+1,initiallyCollapsed:e[this.oTreeProperties["hierarchy-drill-state-for"]]==="collapsed",nodeState:{isLeaf:e[this.oTreeProperties["hierarchy-drill-state-for"]]==="leaf",expanded:e[this.oTreeProperties["hierarchy-drill-state-for"]]==="expanded",collapsed:e[this.oTreeProperties["hierarchy-drill-state-for"]]==="collapsed",selected:this._mSelected[n]?this._mSelected[n].nodeState.selected:false},positionInParent:i,children:[],addedSubtrees:[],parent:t,originalParent:t,isDeepOne:true,containingServerIndex:r};if(this._bSelectAll&&this._aExpandedAfterSelectAll.indexOf(t)===-1){this.setNodeSelection(o,true)}return o};h.prototype._requestChildren=function(t,i,n,o){return new Promise(function(a,s){var d={sParent:t.key,iSkip:i,iTop:n};this._aPendingChildrenRequests.sort(function(e,t){return e.iSkip-t.iSkip});for(var l=0;l<this._aPendingChildrenRequests.length;l++){var h=this._aPendingChildrenRequests[l];if(h.sParent===d.sParent){if(r._determineRequestDelta(d,h)===false){return}}}i=d.iSkip;n=d.iTop;function u(e){var t=this._aPendingChildrenRequests.indexOf(d);this._aPendingChildrenRequests.splice(t,1);a({oData:e,iSkip:i,iTop:n})}function f(e){var t=this._aPendingChildrenRequests.indexOf(d);this._aPendingChildrenRequests.splice(t,1);s(e)}var p=["$skip="+i,"$top="+n];if(t.childCount==undefined||o){p.push("$inlinecount=allpages")}if(this.sCustomParams){p.push(this.sCustomParams)}var c=new e(this.oTreeProperties["hierarchy-parent-node-for"],"EQ",t.context.getProperty(this.oTreeProperties["hierarchy-node-for"]));var v=[c];if(this.aApplicationFilters){v=v.concat(this.aApplicationFilters)}var _=this.oModel.resolve(this.getPath(),this.getContext());if(_){d.oRequestHandle=this.oModel.read(_,{urlParameters:p,filters:[new e({filters:v,and:true})],sorters:this.aSorters||[],success:u.bind(this),error:f.bind(this),groupId:this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId});this._aPendingChildrenRequests.push(d)}}.bind(this))};h.prototype._loadSubTree=function(e,t){var i=this;var n;if(e.serverIndex!==undefined&&!e.initiallyCollapsed){var r=[];var o;var s=e.serverIndex+1;var d=s+e.magnitude;for(var l=s;l<d;l++){if(this._aNodes[l]===undefined){if(!o){o={iSkip:l,iTop:1};r.push(o)}else{o.iTop++}}else{o=null}}if(r.length){n=Promise.all(r.map(function(e){return i._loadData(e.iSkip,e.iTop)}))}}if(!n){n=Promise.resolve()}return n.then(function(){i.fireDataRequested();return i._requestSubTree(e,t).then(function(t){i._addSubTree(t.oData,e);i.fireDataReceived({data:t.oData})},function(e){a.warning("ODataTreeBindingFlat: Error during subtree request",e.message);i.fireDataReceived()})})};h.prototype._addSubTree=function(e,t){if(e.results&&e.results.length>0){var i,n,r,o,a,s=[],d={},l,h,u;if(t.serverIndex!==undefined&&!t.initiallyCollapsed){s=this._aNodes.slice(t.serverIndex,t.serverIndex+t.magnitude+1)}else{s.push(t)}for(h=s.length-1;h>=0;h--){o=s[h];if(o.nodeState.isLeaf){continue}if(o.initiallyCollapsed||o.isDeepOne){o.childCount=undefined;if(o.magnitude&&o.nodeState.expanded){this._propagateMagnitudeChange(o.parent,-o.magnitude)}o.magnitude=0}d[o.context.getProperty(this.oTreeProperties["hierarchy-node-for"])]=o}for(l=0;l<e.results.length;l++){r=e.results[l];i=r[this.oTreeProperties["hierarchy-node-for"]];if(d[i]){continue}n=r[this.oTreeProperties["hierarchy-parent-node-for"]];a=d[n];if(a.childCount===undefined){a.childCount=0}o=a.children[a.childCount];if(o){s.push(o);if(o.childCount){o.childCount=undefined;if(o.initiallyCollapsed||o.isDeepOne){o.magnitude=0}}}else{o=this._createChildNode(r,a,a.childCount);if(o.nodeState.expanded){this._aExpanded.push(o);this._sortNodes(this._aExpanded)}}a.childCount++;if(a.nodeState.expanded){this._propagateMagnitudeChange(a,1)}else{a.magnitude++}if(!o.nodeState.isLeaf){d[i]=o}}for(u=s.length-1;u>=0;u--){o=s[u];if(!o.nodeState.expanded&&!o.nodeState.isLeaf){this.expand(o,true)}}}};h.prototype._requestSubTree=function(t,i){return new Promise(function(n,r){var o={sParent:t.key,iLevel:i};for(var a=0;a<this._aPendingSubtreeRequests.length;a++){var s=this._aPendingSubtreeRequests[a];if(s.sParent===o.sParent&&s.iLevel===o.iLevel){return}}function d(e){var t=this._aPendingSubtreeRequests.indexOf(o);this._aPendingSubtreeRequests.splice(t,1);n({oData:e,sParent:o.sParent,iLevel:o.iLevel})}function l(e){var t=this._aPendingSubtreeRequests.indexOf(o);this._aPendingSubtreeRequests.splice(t,1);r(e)}var h=[];if(this.sCustomParams){h.push(this.sCustomParams)}var u=new e(this.oTreeProperties["hierarchy-node-for"],"EQ",t.context.getProperty(this.oTreeProperties["hierarchy-node-for"]));var f=new e(this.oTreeProperties["hierarchy-level-for"],"LE",i);var p=[u,f];if(this.aApplicationFilters){p=p.concat(this.aApplicationFilters)}var c=this.oModel.resolve(this.getPath(),this.getContext());if(c){o.oRequestHandle=this.oModel.read(c,{urlParameters:h,filters:[new e({filters:p,and:true})],sorters:this.aSorters||[],success:d.bind(this),error:l.bind(this),groupId:this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId});this._aPendingSubtreeRequests.push(o)}}.bind(this))};h.prototype.findNode=function(e){return this._bReadOnly?this._indexFindNode(e):this._mapFindNode(e)};h.prototype._mapFindNode=function(e){if(this.isInitial()){return}var t=this._aNodeCache[e];if(t){return t}var i=-1;this._map(function(n,r,o,a,s){i++;if(i===e){t=n;r.broken=true}});return t};h.prototype._indexFindNode=function(e){if(this.isInitial()){return}var t=this._aNodeCache[e];if(t){return t}var i=this.getNodeInfoByRowIndex(e),t;if(i.parent){t=i.parent.children[i.childIndex]}else{t=this._aNodes[i.index]}this._aNodeCache[e]=t;return t};h.prototype.toggleIndex=function(e){var t=this.findNode(e);s(t!=undefined,"toggleIndex("+e+"): Node not found!");if(t){if(t.nodeState.expanded){this.collapse(t)}else{this.expand(t)}}};h.prototype.expand=function(e,t){var i=e;if(typeof e!=="object"){i=this.findNode(e);s(i!=undefined,"expand("+e+"): Node not found!")}if(i.nodeState.expanded){return}i.nodeState.expanded=true;i.nodeState.collapsed=false;var r=this._aCollapsed.indexOf(i);if(r!=-1){this._aCollapsed.splice(r,1)}this._aExpanded.push(i);this._sortNodes(this._aExpanded);if(i.serverIndex!==undefined){this._aNodeChanges[i.serverIndex]=true}if(this._bSelectAll){this._aExpandedAfterSelectAll.push(i)}if(i.initiallyCollapsed&&i.childCount==undefined){this._loadChildren(i,0,this._iPageSize)}else{this._propagateMagnitudeChange(i.parent,i.magnitude)}this._cleanTreeStateMaps();this._aNodeCache=[];if(!t){this._fireChange({reason:n.Expand})}};h.prototype.expandToLevel=function(e){this.setNumberOfExpandedLevels(e)};h.prototype.expandNodeToLevel=function(e,t,i){if(!this._bReadOnly){return Promise.reject(new Error("ODataTreeBindingFlat: expandNodeToLevel is not supported while there are pending changes in the hierarchy"))}var r=this.findNode(e);return this._loadSubTree(r,t).then(function(){if(!i){this._fireChange({reason:n.Expand})}}.bind(this))};h.prototype.collapse=function(e,t){var i=e;if(typeof e!=="object"){i=this.findNode(e);s(i!=undefined,"expand("+e+"): Node not found!")}if(i.nodeState.collapsed){return}i.nodeState.expanded=false;i.nodeState.collapsed=true;var r=this._aExpanded.indexOf(i);if(r!=-1){this._aExpanded.splice(r,1)}if(this._bSelectAll){r=this._aExpandedAfterSelectAll.indexOf(i);if(r!==-1){this._aExpandedAfterSelectAll.splice(r,1)}}this._aCollapsed.push(i);this._sortNodes(this._aCollapsed);if(i.isDeepOne){this._propagateMagnitudeChange(i.parent,i.magnitude*-1)}if(i.serverIndex!==undefined){this._aNodeChanges[i.serverIndex]=true}this._cleanUpSelection();this._cleanTreeStateMaps();this._aNodeCache=[];if(!t){this._fireChange({reason:n.Collapse})}};h.prototype.collapseToLevel=function(e){if(this.bCollapseRecursive){for(var t in this._mSelected){var i=this._mSelected[t];if(i.level>e){this.setNodeSelection(i,false)}}}this.setNumberOfExpandedLevels(e)};h.prototype._getInvisibleSelectedNodes=function(){var e=[];var t=true;var i=function(e,i){if(e.nodeState.collapsed||e.nodeState.removed&&!e.nodeState.reinserted){t=false;i.broken=true}};for(var n in this._mSelected){var r=this._mSelected[n];t=true;this._up(r,i,false);if(!t){e.push(r)}}return e};h.prototype._cleanUpSelection=function(e){var t=this._getInvisibleSelectedNodes();t.forEach(function(t){if(t.key==this._sLeadSelectionKey){this._sLeadSelectionKey=null}if(this.bCollapseRecursive||e){this.setNodeSelection(t,false)}}.bind(this))};h.prototype._isInSubtree=function(e,t){var i=false;var n=function(t,n){if(t==e){n.broken=true;i=true}};this._up(t,n,false);return i};h.prototype._up=function(e,t,i){var n={broken:false};var r=this._getParent(e,i);if(r){this._structuralUp(r,t,n,i)}else{this._flatUp(e,t,n,true)}};h.prototype._structuralUp=function(e,t,i,n){var r=e;do{t(r,i);if(i.broken){return}e=r;r=this._getParent(r)}while(r);this._flatUp(e,t,i)};h.prototype._flatUp=function(e,t,i,n){var r=e.serverIndex,o=n?r-1:r,a,s;for(;o>=0;o--){if(this._aNodeChanges[o]){a=this._aNodes[o];if(a.initiallyCollapsed){continue}if(a.serverIndex+a.magnitude>=r){t(a,i);if(i.broken){return}s=this._getParent(a);if(s){this._structuralUp(s,t,i);return}}else{continue}}}};h.prototype._getParent=function(e,t){return t?e.originalParent:e.parent};h.prototype._cleanTreeStateMaps=function(){this._iLengthDelta=this._bReadOnly?this._indexCleanTreeStateMaps():this._mapCleanTreeStateMaps()};h.prototype._indexCleanTreeStateMaps=function(){return this._calcIndexDelta(this._aNodes.length)};h.prototype._mapCleanTreeStateMaps=function(){var e=this._aCollapsed.concat(this._aRemoved).concat(this._aExpanded).concat(this._aAdded),t=true,i,n=0,r=function(e,i){if(e.nodeState.collapsed||e.nodeState.removed&&!e.nodeState.reinserted){t=false;i.broken=true}},o={};var a=[[0,1],[-1,0]];e.forEach(function(e){if(o[e.key]){return}else{o[e.key]=true}if(e.nodeState.added){if(!e.nodeState.removed||e.nodeState.reinserted){t=true;this._up(e,r,false);if(t){n++}}}else{if(e.nodeState.collapsed||e.nodeState.expanded||e.nodeState.removed){t=true;this._up(e,r,false);if(t){if(e.nodeState.removed&&!e.nodeState.reinserted){if(e.isDeepOne||e.initiallyCollapsed){n-=1}else{n-=e.magnitude+1}}else{if(e.nodeState.collapsed&&e.serverIndex!==undefined&&!e.initiallyCollapsed){n-=e.magnitude}if(e.nodeState.expanded&&(e.isDeepOne||e.initiallyCollapsed)){n+=e.children.length}}}if(e.nodeState.reinserted){i=t;t=true;this._up(e,r,true);var s=a[t|0][i|0];if(!!s){if(e.isDeepOne){n+=s*1}else{if(e.initiallyCollapsed){n+=s}else{n+=s*(1+e.magnitude)}}}}}}}.bind(this));return n};h.prototype.isLengthFinal=function(){return this._bLengthFinal};h.prototype.getLength=function(){return this._aNodes.length+this._iLengthDelta};h.prototype.getContextByIndex=function(e){if(this.isInitial()){return}var t=this.findNode(e);return t&&t.context};h.prototype.getNodeByIndex=function(e){if(this.isInitial()){return}var t=this.findNode(e);return t};h.prototype.isExpanded=function(e){var t=this.findNode(e);return t&&t.nodeState.expanded};h.prototype.hasChildren=function(e){if(!e){return false}var t=this._findNodeByContext(e);var i=t&&t.node;return!(i&&i.nodeState.isLeaf)};h.prototype.nodeHasChildren=function(e){return!(e&&e.nodeState.isLeaf)};h.prototype.setNodeSelection=function(e,t){s(e,"Node must be defined!");e.nodeState.selected=t;if(t){delete this._mDeselected[e.key];this._mSelected[e.key]=e}else{delete this._mSelected[e.key];this._mDeselected[e.key]=e;if(e.key===this._sLeadSelectionKey){this._sLeadSelectionKey=null}}};h.prototype.isIndexSelected=function(e){var t=this.findNode(e);return t&&t.nodeState?t.nodeState.selected:false};h.prototype.isIndexSelectable=function(e){var t=this.findNode(e);return!!t};h.prototype._clearSelection=function(){return this._bReadOnly?this._indexClearSelection():this._mapClearSelection()};h.prototype._indexClearSelection=function(){var e=-1,t=[],i,n,r;this._bSelectAll=false;this._aExpandedAfterSelectAll=[];for(i in this._mSelected){n=this._mSelected[i];this.setNodeSelection(n,false);r=this.getRowIndexByNode(n);t.push(r);if(this._sLeadSelectionKey==i){e=r}}return{rowIndices:t,oldIndex:e,leadIndex:-1}};h.prototype._mapClearSelection=function(){var e=-1;var t=-1;var i=0;var n=[];this._bSelectAll=false;this._aExpandedAfterSelectAll=[];for(var r in this._mSelected){if(r){i++}}this._map(function(r,o,a,s,d){e++;if(r&&r.nodeState.selected){this.setNodeSelection(r,false);n.push(e);if(this._sLeadSelectionKey==r.key){t=e}if(n.length==i){o.broken=true}}}.bind(this));return{rowIndices:n,oldIndex:t,leadIndex:-1}};h.prototype.setSelectedIndex=function(e){var t=this.findNode(e);if(t){var i=this._clearSelection();var n=i.rowIndices.indexOf(e);if(n>=0){i.rowIndices.splice(n,1)}else{i.rowIndices.push(e)}i.leadKey=t.key;i.leadIndex=e;this.setNodeSelection(t,true);this._publishSelectionChanges(i)}else{a.warning("ODataTreeBindingFlat: The selection of index '"+e+"' was ignored. Please make sure to only select rows, for which data has been fetched to the client.")}};h.prototype.getSelectedIndex=function(){return this._bReadOnly?this._indexGetSelectedIndex():this._mapGetSelectedIndex()};h.prototype._indexGetSelectedIndex=function(){if(!this._sLeadSelectionKey||l(this._mSelected)){return-1}var e=this._mSelected[this._sLeadSelectionKey];if(e){return this.getRowIndexByNode(e)}else{return-1}};h.prototype._mapGetSelectedIndex=function(){if(!this._sLeadSelectionKey||l(this._mSelected)){return-1}var e=-1;this._map(function(t,i){e++;if(t){if(t.key===this._sLeadSelectionKey){i.broken=true}}}.bind(this));return e};h.prototype.getSelectedIndices=function(){return this._bReadOnly?this._indexGetSelectedIndices():this._mapGetSelectedIndices()};h.prototype._indexGetSelectedIndices=function(){var e=this._getSelectedNodesInfo();return e.map(function(e){return e.rowIndex})};h.prototype._mapGetSelectedIndices=function(){var e=[];if(l(this._mSelected)){return e}var t=-1;this._map(function(i){t++;if(i){if(i.nodeState&&i.nodeState.selected){e.push(t)}}});return e};h.prototype.getSelectedNodesCount=function(){var e;if(this._bSelectAll){if(this._bReadOnly){var t=[],i=0,n;this._aExpandedAfterSelectAll.sort(function(e,t){var i=this._getRelatedServerIndex(e);var n=this._getRelatedServerIndex(t);s(i!=undefined,"getSelectedNodesCount: (containing) Server-Index not found for node 'a'");s(n!=undefined,"getSelectedNodesCount: (containing) Server-Index not found node 'b'");if(i==n&&e.isDeepOne&&t.isDeepOne){return e.originalLevel-t.originalLevel}return i-n}.bind(this));var r=-1,o,a,d;for(d=0;d<this._aExpandedAfterSelectAll.length;d++){o=this._aExpandedAfterSelectAll[d];a=this._getRelatedServerIndex(o);if(a<=r&&!o.initiallyCollapsed){continue}if(o.initiallyCollapsed){r=a}else{r=a+o.magnitude}t.push(o);i+=o.magnitude}var l=function(e,n){if(t.indexOf(e)!==-1){i--;n.broken=true}};for(n in this._mSelected){this._up(this._mSelected[n],l,true)}var h;var u=function(e,i){if(e.nodeState.collapsed||e.nodeState.removed&&!e.nodeState.reinserted||t.indexOf(e)!==-1){h=false;i.broken=true}};for(n in this._mDeselected){h=true;this._up(this._mDeselected[n],u,true);if(h){i++}}e=this.getLength()-i}else{e=0;this._map(function(t,i,n,r,o){var a;if(t){if(t.nodeState.selected){e++}}else if(t===undefined&&n==="serverIndex"){var s=true;for(var d=r-1;d>=0;d--){if(this._aNodeChanges[d]){a=this._aNodes[d];if(a.serverIndex+a.magnitude>=r&&this._aExpandedAfterSelectAll.indexOf(a)!==-1){s=false;break}}}if(s){e++}}}.bind(this))}}else{var f=this._getInvisibleSelectedNodes();e=Math.max(Object.keys(this._mSelected).length-f.length,0)}return e};h.prototype.getSelectedContexts=function(){return this._bReadOnly?this._indexGetSelectedContexts():this._mapGetSelectedContexts()};h.prototype._indexGetSelectedContexts=function(){var e=this._getSelectedNodesInfo();return e.map(function(e){return e.node.context})};h.prototype._mapGetSelectedContexts=function(){var e=[];if(l(this._mSelected)){return e}var t=function(t){if(t){if(t.nodeState.selected&&!t.isArtificial){e.push(t.context)}}};this._map(t);return e};h.prototype.setSelectionInterval=function(e,t){var i=this._clearSelection();var n=this._setSelectionInterval(e,t,true);var r={};var o=[];var a;for(var s=0;s<i.rowIndices.length;s++){a=i.rowIndices[s];r[a]=true}for(s=0;s<n.rowIndices.length;s++){a=n.rowIndices[s];if(r[a]){delete r[a]}else{r[a]=true}}for(a in r){if(r[a]){o.push(parseInt(a))}}this._publishSelectionChanges({rowIndices:o,oldIndex:i.oldIndex,leadIndex:n.leadIndex,leadKey:n.leadKey})};h.prototype._setSelectionInterval=function(e,t,i){return this._bReadOnly?this._indexSetSelectionInterval(e,t,i):this._mapSetSelectionInterval(e,t,i)};h.prototype._indexSetSelectionInterval=function(e,t,i){var n=Math.min(e,t),r=Math.max(e,t),o=[],a=[],s,d,l,h;i=!!i;for(l=n;l<=r;l++){d=this.findNode(l);if(d){if(d.nodeState.selected!==i){a.push(l)}if(d.key===this._sLeadSelectionKey){s=l}this.setNodeSelection(d,i);o.push(d)}}h={rowIndices:a,oldIndex:s,leadIndex:s&&!i?-1:undefined};if(o.length>0&&i){h.leadKey=o[o.length-1].key;h.leadIndex=r}return h};h.prototype._mapSetSelectionInterval=function(e,t,i){var n=Math.min(e,t);var r=Math.max(e,t);var o=[];var a=[];var s=Math.abs(r-n)+1;var d;var l=-1;var h=function(e,t,h,u,f){l++;if(e){if(l>=n&&l<=r){if(e.nodeState.selected!==!!i){a.push(l)}if(e.key===this._sLeadSelectionKey){d=l}this.setNodeSelection(e,!!i);o.push(e);if(o.length===s){t.broken=true}}}}.bind(this);this._map(h);var u={rowIndices:a,oldIndex:d,leadIndex:d&&!i?-1:undefined};if(o.length>0&&i){var f=o[o.length-1];u.leadKey=f.key;u.leadIndex=r}return u};h.prototype.addSelectionInterval=function(e,t){var i=this._setSelectionInterval(e,t,true);this._publishSelectionChanges(i)};h.prototype.removeSelectionInterval=function(e,t){var i=this._setSelectionInterval(e,t,false);this._publishSelectionChanges(i)};h.prototype.selectAll=function(){this._bReadOnly?this._indexSelectAll():this._mapSelectAll()};h.prototype._indexSelectAll=function(){this._bSelectAll=true;this._aExpandedAfterSelectAll=[];var e={rowIndices:[],oldIndex:-1,selectAll:true};var t=this.getLength(),i,n;for(i=0;i<t;i++){n=this.findNode(i);if(n&&!n.isArtificial){if(n.key===this._sLeadSelectionKey){e.oldIndex=i}if(!n.nodeState.selected){e.rowIndices.push(i)}this.setNodeSelection(n,true);e.leadKey=n.key;e.leadIndex=i}}this._publishSelectionChanges(e)};h.prototype._mapSelectAll=function(){this._bSelectAll=true;this._aExpandedAfterSelectAll=[];var e={rowIndices:[],oldIndex:-1,selectAll:true};var t=-1;this._map(function(i){if(!i||!i.isArtificial){t++}if(i){if(i.key===this._sLeadSelectionKey){e.oldIndex=t}if(i){if(!i.isArtificial&&!i.nodeState.selected){e.rowIndices.push(t)}this.setNodeSelection(i,true);e.leadKey=i.key;e.leadIndex=t}}}.bind(this));this._publishSelectionChanges(e)};h.prototype.clearSelection=function(e){var t=this._clearSelection();if(!e){this._publishSelectionChanges(t)}};h.prototype._publishSelectionChanges=function(e){e.oldIndex=e.oldIndex||this.getSelectedIndex();e.rowIndices.sort(function(e,t){return e-t});if(e.leadIndex>=0&&e.leadKey){this._sLeadSelectionKey=e.leadKey}else if(e.leadIndex===-1){this._sLeadSelectionKey=undefined}else{e.leadIndex=e.oldIndex}if(e.rowIndices.length>0||e.leadIndex!=undefined&&e.leadIndex!==-1){this.fireSelectionChanged(e)}};h.prototype.setCollapseRecursive=function(e){this.bCollapseRecursive=!!e};h.prototype.resetData=function(){i.prototype.resetData.apply(this,arguments);this._aNodes=[];this._aNodeCache=[];this._aCollapsed=[];this._aExpanded=[];this._aExpandedAfterSelectAll=[];this._mSelected={};this._mDeselected={};this._aAdded=[];this._aRemoved=[];this._aNodeChanges=[];this._aAllChangedNodes=[];this._bLengthFinal=false;this._iLowestServerLevel=null;this._bSelectAll=false;this._bReadOnly=true;this._iLengthDelta=0};h.prototype._findNodeByContext=function(e){for(var t in this._aNodeCache){if(this._aNodeCache[t]&&this._aNodeCache[t].context==e){return{node:this._aNodeCache[t],index:parseInt(t)}}}var i=-1;var n;this._map(function(t,r,o,a,s){i++;if(t){if(t.context===e){n=t;r.broken=true}}});return{node:n,index:i}};h.prototype._getCorrectChangeGroup=function(e){if(!e){e=this.oModel.resolve(this.getPath(),this.getContext())}return this.oModel._resolveGroup(e).groupId};h.prototype.createEntry=function(e){var t=this.oModel.resolve(this.getPath(),this.getContext());var i;if(t){e=e||{};e.groupId=this._getCorrectChangeGroup(t);e.refreshAfterChange=false;i=this.oModel.createEntry(t,e)}else{a.warning("ODataTreeBindingFlat: createEntry failed, as the binding path could not be resolved.")}return i};h.prototype.submitChanges=function(e){e=e||{};var t=this.oModel.resolve(this.getPath(),this.getContext()),i=this._optimizeChanges();if(!t){a.warning("ODataTreeBindingFlat: submitChanges failed, because the binding-path could not be resolved.");return}e.groupId=this._getCorrectChangeGroup(t);var n=e.success||function(){};var r=e.error||function(){};var o=false;e.success=function(e){n(e);var t=false;if(e.__batchResponses&&e.__batchResponses[0]&&e.__batchResponses[0].__changeResponses&&e.__batchResponses[0].__changeResponses.length>0){var r=e.__batchResponses[0].__changeResponses;for(var s=0;s<r.length;s++){var d=r[s];var l=parseInt(d.statusCode);if(l<200||l>299){t=true;break}}if(t){}else if(this._bRestoreTreeStateAfterChange&&!o&&(!this.aApplicationFilters||this.aApplicationFilters.length===0)){this._restoreTreeState(i).catch(function(e){a.error("ODataTreeBindingFlat - "+e.message,e.stack);this._refresh(true)}.bind(this))}else{this._refresh(true)}}else{a.warning("ODataTreeBindingFlat.submitChanges - success: Batch-request response does not contain change response.")}}.bind(this);e.error=function(e){r(e)};this._generateSubmitData(i,function(e){a.error("ODataTreeBindingFlat - Tree state restoration request failed. "+e.message,e.stack);o=true});this.oModel.submitChanges(e)};h.prototype._generateSubmitData=function(e,t){var i=e.removed,n=e.creationCancelled,r=e.added,o=e.moved,d=this;function l(e){s(e.context,"Node does not have a context.");var t=e.parent.context.getProperty(d.oTreeProperties["hierarchy-node-for"]);d.oModel.setProperty(d.oTreeProperties["hierarchy-parent-node-for"],t,e.context)}var h={groupId:this._getCorrectChangeGroup(),error:t};r.forEach(l);o.forEach(function(e){l(e);if(this._bRestoreTreeStateAfterChange&&(!this.aApplicationFilters||this.aApplicationFilters.length===0)){this._generatePreorderPositionRequest(e,h);this._generateSiblingsPositionRequest(e,h)}}.bind(this));i.forEach(function(e){this._generateDeleteRequest(e);a.debug("ODataTreeBindingFlat: DELETE "+e.key)}.bind(this));n.forEach(function(e){this._generateDeleteRequest(e)}.bind(this))};h.prototype._generatePreorderPositionRequest=function(t,i){var n,r,o,a,s,l,h=[],u=this.aSorters||[],f;if(i){n=i.groupId||this.sGroupId;s=i.success;l=i.error}if(this.aApplicationFilters){h=h.concat(this.aApplicationFilters)}for(f=this._aTreeKeyProperties.length-1;f>=0;f--){r=this._aTreeKeyProperties[f];if(!o){o=r}else{o+=","+r}h.push(new e(r,"EQ",t.context.getProperty(r)))}h.push(new e(this.oTreeProperties["hierarchy-level-for"],"LE",this.getNumberOfExpandedLevels()));a=d.extend({},this.mParameters);a.select=o+","+this.oTreeProperties["hierarchy-node-for"]+","+this.oTreeProperties["hierarchy-node-descendant-count-for"]+","+this.oTreeProperties["hierarchy-drill-state-for"]+","+this.oTreeProperties["hierarchy-preorder-rank-for"];var p=this.oModel.resolve(this.getPath(),this.getContext());if(p){this.oModel.read(p,{urlParameters:this.oModel.createCustomParams(a),filters:[new e({filters:h,and:true})],sorters:u,groupId:n,success:s,error:l})}};h.prototype._generateSiblingsPositionRequest=function(e,t){var i,n,r,o;if(t){i=t.groupId||this.sGroupId;r=t.success;o=t.error}n=d.extend({},this.mParameters);n.select=this.oTreeProperties["hierarchy-sibling-rank-for"];this.oModel.read(e.context.getPath(),{urlParameters:this.oModel.createCustomParams(n),groupId:i,success:r,error:o})};h.prototype._nodeIsOnTopLevel=function(e){if(e&&e.serverIndex>=0){var t=e.parent==null;if(t){if(e.originalLevel==this._iLowestServerLevel){return true}else{return false}}}else{a.warning("ODataTreeBindingFlat.nodeIsOnTopLevel: Node is not defined or not a server-indexed node.")}};h.prototype._generateDeleteRequest=function(e){var t=e.context;if(e.nodeState.added){this.oModel.deleteCreatedEntry(t)}else{var i=this.oModel.remove(t.getPath(),{groupId:this._getCorrectChangeGroup(),refreshAfterChange:false});return i}};h.prototype._filterChangeForServerSections=function(e){var t={};t.removed=e.removed.filter(function(e){return!e.isDeepOne});t.added=e.added.filter(function(e){return!e.isDeepOne});e.moved.forEach(function(e){if(!e.newIsDeepOne){t.added.push(e)}if(!e.isDeepOne){t.removed.push(e)}});return t};h.prototype._filterChangesForDeepSections=function(e){var t={};e.removed.forEach(function(e){var i;if(e.isDeepOne){i=e.parent;if(!t[i.key]){t[i.key]={added:[],removed:[]}}t[i.key].removed.push(e)}});e.added.forEach(function(e){var i;if(e.isDeepOne){i=e.parent;if(!t[i.key]){t[i.key]={added:[],removed:[]}}t[i.key].added.push(e)}});e.moved.forEach(function(e){var i;if(e.newIsDeepOne){i=e.parent;if(!t[i.key]){t[i.key]={added:[],removed:[]}}t[i.key].added.push(e)}if(e.isDeepOne){i=e.originalParent;if(!t[i.key]){t[i.key]={added:[],removed:[]}}t[i.key].removed.push(e)}});return t};h.prototype._optimizeOptimizedChanges=function(e){var t,i=this;t=e.added.slice();t.sort(function(e,t){var n=e.newIsDeepOne!==undefined?e.newIsDeepOne:e.isDeepOne,r=t.newIsDeepOne!==undefined?t.newIsDeepOne:t.isDeepOne;if(n&&r){return 0}if(n){return 1}if(r){return-1}return e.context.getProperty(i.oTreeProperties["hierarchy-preorder-rank-for"])-t.context.getProperty(i.oTreeProperties["hierarchy-preorder-rank-for"])});var n=-1;t=t.filter(function(e,t){if(e.newIsDeepOne!==undefined?e.newIsDeepOne:e.isDeepOne){return true}if(t<=n){return false}var r=e.context.getProperty(i.oTreeProperties["hierarchy-node-descendant-count-for"]);if(r){n=t+r}return true});return{added:t,removed:e.removed,moved:e.moved}};h.prototype._updateNodeInfoAfterSave=function(e){var t=e.context.getProperty(this.oTreeProperties["hierarchy-preorder-rank-for"])===undefined;if(e.isDeepOne===undefined){e.isDeepOne=t}else{e.newIsDeepOne=t}var i=e.context.getProperty(this.oTreeProperties["hierarchy-drill-state-for"])==="collapsed";if(e.initiallyCollapsed===undefined){e.initiallyCollapsed=i}else{e.newInitiallyCollapsed=i}};h.prototype._requestExtraInfoForAddedNodes=function(e){var t=[],i=this;e.forEach(function(e){var n=new Promise(function(t,n){i._generatePreorderPositionRequest(e,{success:t,error:n})});t.push(n)});t=t.map(function(e){return e.then(function(e){return{responseData:e}},function(e){return{error:e}})});return Promise.all(t).then(function(e){var t=0;e.forEach(function(e){if(e.error){if(e.error.statusCode===0){t++}else{throw new Error("Tree state restoration request failed. Complete or partial tree state might get lost. Error: "+(e.error.message.value||e.error.message))}}});return t===0})};h.prototype._restoreTreeState=function(e){var t=this;this._abortPendingRequest();e=e||{creationCancelled:[],added:[],removed:[],moved:[]};this.fireDataRequested();return this._requestExtraInfoForAddedNodes(e.added).then(function(i){if(i){return t._executeRestoreTreeState(e).then(function(e){if(e){t._fireChange({reason:n.Change});t.fireDataReceived({data:e});return e}})}})};h.prototype._executeRestoreTreeState=function(e){var t,i,n,r,o,a,s,d,l,h,u,f,p,c=this;e.added.forEach(this._updateNodeInfoAfterSave.bind(this));e.moved.forEach(this._updateNodeInfoAfterSave.bind(this));s=[];n=this._collectServerSections(this._aNodes);e=this._optimizeOptimizedChanges(e);f=this._filterChangeForServerSections(e);this._adaptSections(n,f);for(d=0;d<n.length;d++){i=n[d];s.push(this._restoreServerIndexNodes(i.iSkip,i.iTop,d===0))}var v=this._collectDeepNodes();p=this._filterChangesForDeepSections(e);for(l=0;l<v.length;l++){r=v[l];if(p){f=p[r.oParentNode.key];if(f){this._adaptSections(r.aChildSections,f,{indexName:"positionInParent",ignoreMagnitude:true})}}for(h=0;h<r.aChildSections.length;h++){o=r.aChildSections[h];s.push(this._restoreChildren(r.oParentNode,o.iSkip,o.iTop))}}a={};for(u=0;u<this._aCollapsed.length;u++){a[this._aCollapsed[u].key]=true}t=this._aCollapsed.length;this.resetData(true);function _(){if(t>0){c._map(function(e,i){if(e&&a[e.key]){c.collapse(e,true);t--;if(t===0){i.broken=true}}})}}s=s.map(function(e){return e.then(function(e){return{responseData:e}},function(e){return{error:e}})});return Promise.all(s).then(function(e){var t=0;e.forEach(function(e){if(e.error){if(e.error.statusCode===0){t++}else{throw new Error("Tree state restoration request failed. Complete or partial tree state might get lost. Error: "+(e.error.message.value||e.error.message))}}});if(t<e.length){_();return e}})};h.prototype._collectServerSections=function(e){var t=[];var i;for(var n=0;n<e.length;n++){if(e[n]!==undefined){if(!i){i={iSkip:n,iTop:1};t.push(i)}else{i.iTop++}}else{i=null}}return t};h.prototype._adaptSections=function(e,t,i){var n=t.removed||[],r=t.added||[],o=i&&i.indexName||"serverIndex",s,d,l,h,u,f=0,p,c,v,_,g,S,x,y=0,m,C,I=[];for(var b=r.length-1;b>=0;b--){s=r[b];if(s.newIsDeepOne!==undefined?s.newIsDeepOne:s.isDeepOne){C=this.oTreeProperties["hierarchy-sibling-rank-for"]}else{C=this.oTreeProperties["hierarchy-preorder-rank-for"];if(s.newInitiallyCollapsed!==undefined?!s.newInitiallyCollapsed:!s.initiallyCollapsed){p=s.context.getProperty(this.oTreeProperties["hierarchy-node-descendant-count-for"])}}c=s.context.getProperty(C);if(c===undefined){a.warning("ODataTreeBindingFlat","Missing "+C+" value for node "+s.key);break}I.push({position:c,magnitude:p||0,assignedToSection:false})}for(var P=0;P<e.length;P++){d=e[P];x=y;v=_;_=0;m=0;for(var N=n.length-1;N>=0;N--){s=n[N];c=s[o];if(c>=d.iSkip&&c<=d.iSkip+d.iTop){if(o==="serverIndex"){f++}p=i&&i.ignoreMagnitude?0:this._getInitialMagnitude(s);u=1+p;h=d.iSkip+d.iTop-c-u;if(h>0){m-=u}else{m-=d.iSkip+d.iTop-c;if(h<0){_=c+u}}x-=u}}if(d.iSkip<=v){g=d.iSkip-v;m+=g;if(d.iTop+m<0){_=v}}d.iSkip+=y;d.iTop+=m;if(d.iTop>0){y=0;m=0;for(var R=0;R<I.length;R++){l=I[R];c=l.position;S=i&&i.ignoreMagnitude?1:l.magnitude+1;if(c>=d.iSkip&&c<=d.iSkip+d.iTop){m+=S;I[R].assignedToSection=true}else if(c<d.iSkip){y+=S}}d.iSkip+=y;d.iTop+=m;d.iTop+=f}if(d.iTop<=0){e.splice(P,1);P--}y=x}for(var k=0;k<I.length;k++){l=I[k];S=i&&i.ignoreMagnitude?1:l.magnitude+1;if(!l.assignedToSection){e.push({iSkip:l.position,iTop:S})}}e.sort(function(e,t){return e.iSkip-t.iSkip});for(var T=0;T<e.length;T++){if(T+1<e.length){d=e[T];var D=e[T+1];if(d.iSkip+d.iTop===D.iSkip){d.iTop+=D.iTop;e.splice(T+1,1);T--}}}};h.prototype._optimizeChanges=function(){var e=[],t=[],i=[],n=[];var r=false;var o=function(e,t){if(e.nodeState.removed&&!e.nodeState.reinserted){r=true;t.broken=true}};var a=[];var d=function(e){if((e.isDeepOne||e.serverIndex>=0)&&a.indexOf(e)==-1){a.push(e)}if(e.nodeState.added){t.push(e)}};this._aAllChangedNodes.forEach(function(e){r=false;this._up(e,o,false);if(r){d(e)}else{if(e.nodeState.removed&&!e.nodeState.reinserted){d(e)}else if(e.nodeState.added){i.push(e)}else{n.push(e)}}}.bind(this));a.sort(function(e,t){var i=this._getRelatedServerIndex(e);var n=this._getRelatedServerIndex(t);s(i!=undefined,"_generateSubmitData: (containing) Server-Index not found for node 'a'");s(n!=undefined,"_generateSubmitData: (containing) Server-Index not found node 'b'");if(i==n&&e.isDeepOne&&t.isDeepOne){if(e.parent===t.parent){return e.positionInParent-t.positionInParent}else{return e.originalLevel-t.originalLevel}}return i-n}.bind(this));var l=function(e){var t=false;this._up(e,function(e,i){if(e.nodeState.removed&&!e.nodeState.reinserted){t=true;i.broken=true}},true);return t}.bind(this);for(var h=0;h<a.length;h++){var u=a[h];if(!l(u)){e.push(u)}}return{removed:e,creationCancelled:t,added:i,moved:n}};h.prototype._collectDeepNodes=function(){var e=[],t=this;this._map(function(i){if(i&&i.nodeState.expanded&&(i.initiallyCollapsed||i.isDeepOne)){e.push({oParentNode:i,aChildSections:t._collectServerSections(i.children)})}});return e};h.prototype._trackChangedNode=function(e){if(this._aAllChangedNodes.indexOf(e)==-1){this._aAllChangedNodes.push(e)}};h.prototype.addContexts=function(e,t){var i=this._findNodeByContext(e),r=i.node,o=this.getModel(),d,l;s(e&&t,"ODataTreeBinding.addContexts() was called with incomplete arguments!");if(r){this._bReadOnly=false;if(r.nodeState&&r.nodeState.isLeaf){r.nodeState.isLeaf=false;r.nodeState.collapsed=true}if(!Array.isArray(t)){if(t instanceof sap.ui.model.Context){t=[t]}else{a.warning("ODataTreeBinding.addContexts(): The child node argument is not of type sap.ui.model.Context.")}}var h=function(e){return function(){return[e]}};t=t.slice();t.reverse();for(var u=0;u<t.length;u++){var l=t[u];if(!l||!(l instanceof sap.ui.model.Context)){a.warning("ODataTreeBindingFlat.addContexts(): no valid child context given!");return}var d=this._mSubtreeHandles[l.getPath()];this._ensureHierarchyNodeIDForContext(l);if(d&&d._isRemovedSubtree){a.info("ODataTreeBindingFlat.addContexts(): Existing context added '"+l.getPath()+"'");d._oNewParentNode=r;d._oSubtreeRoot.nodeState.reinserted=true;d._oSubtreeRoot.originalParent=d._oSubtreeRoot.originalParent||d._oSubtreeRoot.parent;d._oSubtreeRoot.parent=r;d._oSubtreeRoot.containingSubtreeHandle=d;l=d.getContext();this._trackChangedNode(d._oSubtreeRoot);this._mSubtreeHandles[l.getPath()]}else{a.info("ODataTreeBindingFlat.addContexts(): Newly created context added.");this._ensureHierarchyNodeIDForContext(l);var f={context:l,key:o.getKey(l),parent:r,nodeState:{isLeaf:true,collapsed:false,expanded:false,selected:false,added:true},addedSubtrees:[],children:[],magnitude:0};this._trackChangedNode(f);this._aAdded.push(f);d={_getSubtree:h(f),_oSubtreeRoot:null,_oNewParentNode:r}}d._iContainingServerIndex=r.serverIndex||r.containingServerIndex;r.addedSubtrees.unshift(d);if(r.serverIndex!==undefined){this._aNodeChanges[r.serverIndex]=true}}this._aNodeCache=[];this._cleanTreeStateMaps();this._fireChange({reason:n.Add})}else{a.warning("The given parent context could not be found in the tree. No new sub-nodes were added!")}};h.prototype._ensureHierarchyNodeIDForContext=function(e){if(e){var t=e.getProperty(this.oTreeProperties["hierarchy-node-for"]);if(e.bCreated&&!t){this.oModel.setProperty(this.oTreeProperties["hierarchy-node-for"],o(),e)}}};h.prototype.removeContext=function(e){var t=this;var i=this._findNodeByContext(e);var r=i.node;var o=i.index;if(r){this._bReadOnly=false;r.nodeState.removed=true;this._aRemoved.push(r);this._trackChangedNode(r);if(r.serverIndex!==undefined){this._aNodeChanges[r.serverIndex]=true}if(r.containingSubtreeHandle&&r.parent!=null){var s=r.parent.addedSubtrees.indexOf(r.containingSubtreeHandle);if(s!=-1){r.parent.addedSubtrees.splice(s,1);r.nodeState.reinserted=false;r.parent=null}}this._aNodeCache=[];this.setNodeSelection(r,false);this._cleanUpSelection(true);this._cleanTreeStateMaps();this._fireChange({reason:n.Remove});this._mSubtreeHandles[e.getPath()]={_removedFromVisualIndex:o,_isRemovedSubtree:true,_oSubtreeRoot:r,_getSubtree:function(){if(r.serverIndex!=undefined&&!r.initiallyCollapsed){return t._aNodes.slice(r.serverIndex,r.serverIndex+r.magnitude+1)}else{return r}},getContext:function(){return e},_restore:function(){r.nodeState.removed=false;var e=t._aRemoved.indexOf(r);if(e!=-1){t._aRemoved.splice(e,1)}this._aNodeCache=[];t._cleanTreeStateMaps();t._fireChange({reason:n.Add})}};return e}else{a.warning("ODataTreeBinding.removeContexts(): The given context is not part of the tree. Was it removed already?")}};h.prototype._getRelatedServerIndex=function(e){if(e.serverIndex===undefined){return e.containingServerIndex}else{return e.serverIndex}};h.prototype.getNodeInfoByRowIndex=function(e){var t=0,i=0,n,r,o=-1;while(t<this._aCollapsed.length||i<this._aExpanded.length){if(this._aCollapsed[t]&&this._aExpanded[i]){if(this._getRelatedServerIndex(this._aCollapsed[t])>this._getRelatedServerIndex(this._aExpanded[i])){n=this._aExpanded[i];i++;r=false}else{n=this._aCollapsed[t];t++;r=true}}else if(this._aCollapsed[t]){n=this._aCollapsed[t];t++;r=true}else{n=this._aExpanded[i];i++;r=false}if(e<=this._getRelatedServerIndex(n)){break}if(r){if(!n.isDeepOne&&!n.initiallyCollapsed&&n.serverIndex>o){e+=n.magnitude;o=n.serverIndex+n.magnitude}}else{if(n.serverIndex>o){if(!n.isDeepOne&&n.initiallyCollapsed){e-=n.magnitude}if(e<=n.serverIndex){return this._calcDirectIndex(n,e+n.magnitude-n.serverIndex-1)}}}}return{index:e}};h.prototype._calcDirectIndex=function(e,t){var i,n,r;for(i=0;i<e.children.length;i++){r=e.children[i];if(t===0){return{parent:e,childIndex:i}}n=r?r.magnitude:0;t--;if(!r||r.nodeState.collapsed){continue}if(t<n){return this._calcDirectIndex(r,t)}else{t-=n}}};h.prototype.getRowIndexByNode=function(e){var t=0;var i;var n;if(e.isDeepOne){while(e.parent){t+=e.positionInParent+1;for(n=0;n<e.positionInParent;n++){i=e.parent.children[n];if(i&&i.nodeState.expanded){t+=i.magnitude}}e=e.parent}}return this._calcIndexDelta(e.serverIndex)+e.serverIndex+t};h.prototype._getSelectedNodesInfo=function(){var e=[];if(l(this._mSelected)){return e}var t=true;var i=function(e,i){if(e.nodeState.collapsed||e.nodeState.removed&&!e.nodeState.reinserted){t=false;i.broken=true}};for(var n in this._mSelected){var r=this._mSelected[n];t=true;this._up(r,i,false);if(t){e.push({node:r,rowIndex:this.getRowIndexByNode(r)})}}e.sort(function(e,t){return e.rowIndex-t.rowIndex});return e};h.prototype._calcIndexDelta=function(e){var t={};this._aCollapsed.forEach(function(i){if(i.serverIndex>=0&&i.serverIndex<e&&!i.isDeepOne&&!i.initiallyCollapsed){t[i.serverIndex]=i.magnitude}});var i=0;var n=0;for(var r=0;r<this._aCollapsed.length;r++){var o=this._aCollapsed[r];if(this._getRelatedServerIndex(o)>=e){break}if(!o.isDeepOne){if(o.serverIndex>=i&&!o.initiallyCollapsed){n-=o.magnitude;i=o.serverIndex+o.magnitude}else{}}else{}}var a=0;var s=function(e){var i=false;var n=e.serverIndex||e.containingServerIndex;for(var r in t){if(n>r&&n<r+t[r]){i=true;break}}return i};for(r=0;r<this._aExpanded.length;r++){var d=this._aExpanded[r];if(this._getRelatedServerIndex(d)>=e){break}if(d.isDeepOne){var l=d.parent;var h=false;while(l){if(l.nodeState.collapsed){h=true;break}l=l.parent}var u=s(d);if(!h&&!u){a+=d.children.length}}else if(d.initiallyCollapsed){var u=s(d);if(!u){a+=d.children.length}}}return a+n};h.prototype._sortNodes=function(e){var t=function(e,t){var i=this._getRelatedServerIndex(e);var n=this._getRelatedServerIndex(t);return i-n}.bind(this);e.sort(t)};h.prototype._abortPendingRequest=function(){i.prototype._abortPendingRequest.apply(this,arguments);var e,t;for(e=this._aPendingRequests.length-1;e>=0;e--){this._aPendingRequests[e].oRequestHandle.abort()}this._aPendingRequests=[];for(t=this._aPendingChildrenRequests.length-1;t>=0;t--){this._aPendingChildrenRequests[t].oRequestHandle.abort()}this._aPendingChildrenRequests=[]};h.prototype.attachSelectionChanged=function(e,t,i){this.attachEvent("selectionChanged",e,t,i);return this};h.prototype.detachSelectionChanged=function(e,t){this.detachEvent("selectionChanged",e,t);return this};h.prototype.fireSelectionChanged=function(e){this.fireEvent("selectionChanged",e);return this};h.prototype.getRootContexts=function(){};h.prototype.getNodeContexts=function(){};return h},true);