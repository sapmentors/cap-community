/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/util/reflection/JsControlTreeModifier","sap/base/util/uid","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,r,t,o){"use strict";var n={};n.CHANGE_TYPE_MOVE_FIELD="moveSimpleFormField";n.CHANGE_TYPE_MOVE_GROUP="moveSimpleFormGroup";n.sTypeTitle="sap.ui.core.Title";n.sTypeMTitle="sap.m.Title";n.sTypeToolBar="sap.m.Toolbar";n.sTypeOverflowToolBar="sap.m.OverflowToolbar";n.sTypeLabel="sap.m.Label";n.sTypeSmartLabel="sap.ui.comp.smartfield.SmartLabel";n.CONTENT_AGGREGATION="content";var a=function(e,r,t){for(var o=0;o<t.length;o++){var n=e.getControlType(t[o]);if(r.indexOf(n)===-1){if(e.getVisible(t[o])){return true}}else{return false}}};var l=function(e,r,t,o,n,l,i){if(a(r,l,t)){var p=n.view;var v=n.appComponent;var c=r.createControl("sap.ui.core.Title",v,p,i);r.setProperty(c,"text","");r.insertAggregation(o,"content",c,0,p);var g=e.getRevertData();g.createdTitleSelector=n.modifier.getSelector(c,n.appComponent);e.setRevertData(g)}return r.getAggregation(o,"content")};var i=function(e,r,t,o){var n;var l=-1;if(a(e,r,t)){l++}for(var i=0;i<t.length;i++){var p=e.getControlType(t[i]);if(r.indexOf(p)>-1){l++;if(l===o){n=t[i];break}}}return t.indexOf(n)};var p=function(e,r,t){if(r>=e.length||r===-1){return true}var o=t.getControlType(e[r]);return n.sTypeTitle===o||n.sTypeToolBar===o||n.sTypeMTitle===o||n.sTypeOverflowToolBar===o};var v=function(e,r,t,o){var n=0;for(n=r+1;n<t.length;++n){var a=e.getControlType(t[n]);if(o.indexOf(a)>-1){break}}return n-r};var c=function(e,r,t){return v(e,t,r,[n.sTypeTitle,n.sTypeMTitle,n.sTypeToolBar,n.sTypeOverflowToolBar,n.sTypeLabel,n.sTypeSmartLabel])};var g=function(e,r,o,n,a){if(!p(r,o,e)){t.error("Illegal argument. iIndex has to point to a Label.")}else{n=a?n+1:n;var l=0;var i=o;var v;while(i<r.length&&l<n){++l;v=c(e,r,i);i+=v}return i}};var s=function(e,r,t,o,n){var a=t;for(var l=0;l<n;l++){a.splice(o+l,0,e[r+l])}return a};var u=function(e){var r=e.getTitle();if(!r){r=e.getToolbar()}return r};var d=function(r,t,o,a,l){var i=u(t.element);var p=e.getSelector(r,l.appComponent);var v={elementSelector:e.getSelector(i,l.appComponent),source:{groupIndex:t.sourceIndex},target:{groupIndex:t.targetIndex}};return{changeType:n.CHANGE_TYPE_MOVE_GROUP,targetSelector:p,movedControl:i,movedElements:[v]}};var f=function(r,t,o,a,l){var i=e.getSelector(r,l.appComponent);var p=t.element.getLabel();var v=e.getSelector(p,l.appComponent);var c=u(a.parent);var g=u(o.parent);var s=e.getSelector(c,l.appComponent);var d=e.getSelector(g,l.appComponent);var f={elementSelector:v,source:{groupSelector:d,fieldIndex:t.sourceIndex},target:{groupSelector:s,fieldIndex:t.targetIndex}};return{changeType:n.CHANGE_TYPE_MOVE_FIELD,targetSelector:i,target:c,source:g,movedControl:p,movedElements:[f]}};var m=function(e,r,t,o,n){e.removeAllAggregation(r,t.CONTENT_AGGREGATION);for(var a=0;a<o.length;++a){e.insertAggregation(r,t.CONTENT_AGGREGATION,o[a],a,n)}};n.applyChange=function(e,r,o){var a=o.modifier;var p=o.view;var u=o.appComponent;var d,f;var T=e.getContent();var y=T.movedElements[0];var C=a.getAggregation(r,n.CONTENT_AGGREGATION);var E=C.map(function(e){return a.getSelector(e,u)});var S={content:E};e.setRevertData(S);if(e.getChangeType()===n.CHANGE_TYPE_MOVE_FIELD){var I=a.bySelector(y.elementSelector||y.element,u,p);var O=C.indexOf(I);var b=c(a,C,O);d=a.bySelector(y.target.groupSelector||y.target.groupId,u,p);var x=C.indexOf(d);var h=a.bySelector(y.source.groupSelector||y.source.groupId,u,p);var G=C.indexOf(h);var _=g(a,C,x,y.target.fieldIndex,G===x&&y.source.fieldIndex<y.target.fieldIndex);var A=c(a,C,_);f=C.slice();var N=f.slice(O,O+b);var w,D,L,M;if(O<_){w=f.slice(0,O);L=f.slice(O+b,_+A);M=f.slice(_+A,f.length);f=w.concat(L.concat(N.concat(M)))}else if(O>_){D=f.slice(0,_+A);L=f.slice(_+A,O);M=f.slice(O+b,f.length);f=D.concat(N.concat(L.concat(M)))}if(O!=_){m(a,r,n,f,p)}}else if(e.getChangeType()===n.CHANGE_TYPE_MOVE_GROUP){var P=[n.sTypeTitle,n.sTypeToolBar,n.sTypeMTitle,n.sTypeOverflowToolBar];var R=a.bySelector(y.elementSelector||y.element,u,p);if(y.target.groupIndex===0||!R){C=l(e,a,C,r,o,P,T.newControlId)}var F=R?C.indexOf(R):0;var B=i(a,P,C,y.target.groupIndex);d=C[B];var V=v(a,B,C,P);var H=v(a,F,C,P);f=C.slice();f.splice(F,H);B=f.indexOf(d);var Y=y.source.groupIndex<y.target.groupIndex?V:0;f=s(C,F,f,B+Y,H);m(a,r,n,f,p)}else{t.warning("Unknown change type detected. Cannot apply to SimpleForm")}return true};n.completeChangeContent=function(e,n,a){var l;var i=a.modifier;var p=a.view;var v=a.appComponent;var c=i.bySelector(n.selector,v,p);var g=n.movedElements;if(g.length>1){t.warning("Moving more than 1 Formelement is not yet supported.")}var s=g[0];s.element=sap.ui.getCore().byId(s.id);var u=o.extend({},n.source);var m=o.extend({},n.target);if(!m.parent){m.parent=sap.ui.getCore().byId(m.id)}if(!u.parent){u.parent=sap.ui.getCore().byId(u.id)}if(c&&s.element&&m.parent){if(n.changeType==="moveSimpleFormGroup"){l=d(c,s,u,m,a)}else if(n.changeType==="moveSimpleFormField"){l=f(c,s,u,m,a)}}else{t.error("Element not found. This may be caused by an unstable id!")}var T=e.getDefinition();T.content.targetSelector=l.targetSelector;T.content.movedElements=l.movedElements;T.content.newControlId=v.createId(r());if(l.source&&l.target){e.addDependentControl(l.source,"sourceParent",a);e.addDependentControl(l.target,"targetParent",a)}e.addDependentControl([l.movedControl],"movedElements",a)};n.revertChange=function(e,r,t){var o=t.modifier;var a=t.appComponent;var l=t.view;var i=e.getRevertData();var p=i.content;var v=p.map(function(e){return o.bySelector(e,a,l)});m(o,r,n,v,l);var c=i.createdTitleSelector;var g=t.modifier.bySelector(c,t.appComponent);if(g){g.destroy()}e.resetRevertData();return true};return n},true);