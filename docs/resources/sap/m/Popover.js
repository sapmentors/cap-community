/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./Bar","./Button","./InstanceManager","./library","./Title","./TitleAlignmentMixin","sap/ui/core/Control","sap/ui/core/Popup","sap/ui/core/delegate/ScrollEnablement","sap/ui/core/theming/Parameters","sap/ui/Device","sap/ui/base/ManagedObject","sap/ui/core/util/ResponsivePaddingsEnablement","sap/ui/core/library","sap/ui/core/Element","sap/ui/core/ResizeHandler","./PopoverRenderer","sap/ui/dom/containsOrEquals","sap/ui/thirdparty/jquery","sap/ui/dom/getScrollbarSize","sap/ui/events/KeyCodes","sap/base/Log","sap/ui/dom/jquery/Focusable","sap/ui/dom/jquery/rect","sap/ui/dom/jquery/control"],function(t,e,i,o,r,s,n,a,l,h,f,p,g,c,u,d,_,m,v,P,y,C){"use strict";var w=o.PopupHelper;var O=c.OpenState;var H=o.PlacementType;var b=o.TitleAlignment;var B=n.extend("sap.m.Popover",{metadata:{interfaces:["sap.ui.core.PopupInterface"],library:"sap.m",properties:{placement:{type:"sap.m.PlacementType",group:"Behavior",defaultValue:H.Right},showHeader:{type:"boolean",group:"Appearance",defaultValue:true},title:{type:"string",group:"Appearance",defaultValue:null},modal:{type:"boolean",group:"Behavior",defaultValue:false},offsetX:{type:"int",group:"Appearance",defaultValue:0},offsetY:{type:"int",group:"Appearance",defaultValue:0},showArrow:{type:"boolean",group:"Appearance",defaultValue:true},contentWidth:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},contentMinWidth:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:""},contentHeight:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},enableScrolling:{type:"boolean",group:"Misc",defaultValue:true,deprecated:true},verticalScrolling:{type:"boolean",group:"Misc",defaultValue:true},horizontalScrolling:{type:"boolean",group:"Misc",defaultValue:true},bounce:{type:"boolean",group:"Behavior",defaultValue:null},resizable:{type:"boolean",group:"Dimension",defaultValue:false},ariaModal:{type:"boolean",group:"Misc",defaultValue:true,visibility:"hidden"},titleAlignment:{type:"sap.m.TitleAlignment",group:"Misc",defaultValue:b.Auto}},defaultAggregation:"content",aggregations:{content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"},customHeader:{type:"sap.ui.core.Control",multiple:false},subHeader:{type:"sap.ui.core.Control",multiple:false},footer:{type:"sap.ui.core.Control",multiple:false},_internalHeader:{type:"sap.m.Bar",multiple:false,visibility:"hidden"},beginButton:{type:"sap.ui.core.Control",multiple:false},endButton:{type:"sap.ui.core.Control",multiple:false}},associations:{leftButton:{type:"sap.m.Button",multiple:false,deprecated:true},rightButton:{type:"sap.m.Button",multiple:false,deprecated:true},initialFocus:{type:"sap.ui.core.Control",multiple:false},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"}},events:{afterOpen:{parameters:{openBy:{type:"sap.ui.core.Control"}}},afterClose:{parameters:{openBy:{type:"sap.ui.core.Control"}}},beforeOpen:{parameters:{openBy:{type:"sap.ui.core.Control"}}},beforeClose:{parameters:{openBy:{type:"sap.ui.core.Control"}}}},designtime:"sap/m/designtime/Popover.designtime"}});B._bIOS7=f.os.ios&&f.os.version>=7&&f.os.version<8&&f.browser.name==="sf";g.call(B.prototype,{header:{suffix:"intHeader"},subHeader:{selector:".sapMPopoverSubHeader .sapMIBar"},content:{suffix:"cont"},footer:{selector:".sapMPopoverFooter .sapMIBar"}});B.prototype.init=function(){this._arrowOffsetThreshold=4;this._marginTopInit=false;this._marginTop=48;this._marginLeft=10;this._marginRight=10;this._marginBottom=10;this._minDimensions={width:100,height:32};this._$window=v(window);this._initialWindowDimensions={};this.oPopup=new a;this.oPopup.setShadow(true);this.oPopup.setAutoClose(true);this.oPopup.setAnimations(v.proxy(this._openAnimation,this),v.proxy(this._closeAnimation,this));this._placements=[H.Top,H.Right,H.Bottom,H.Left,H.Vertical,H.Horizontal,H.Auto,H.VerticalPreferedTop,H.VerticalPreferedBottom,H.HorizontalPreferedLeft,H.HorizontalPreferedRight,H.VerticalPreferredTop,H.VerticalPreferredBottom,H.HorizontalPreferredLeft,H.HorizontalPreferredRight,H.PreferredRightOrFlip,H.PreferredLeftOrFlip,H.PreferredTopOrFlip,H.PreferredBottomOrFlip];this._myPositions=["center bottom","begin center","center top","end center"];this._atPositions=["center top","end center","center bottom","begin center"];this._offsets=["0 -18","18 0","0 18","-18 0"];this._arrowOffset=18;this._followOfTolerance=32;this._scrollContentList=["sap.m.NavContainer","sap.m.Page","sap.m.ScrollContainer","sap.m.SimpleFixFlex"];this._fnAdjustPositionAndArrow=v.proxy(this._adjustPositionAndArrow,this);this._fnOrientationChange=v.proxy(this._onOrientationChange,this);this._fnFollowOf=v.proxy(function(t){var e=t.lastOfRect,i=t.currentOfRect;if(!f.system.desktop||Math.abs(e.top-i.top)<=this._followOfTolerance&&Math.abs(e.left-i.left)<=this._followOfTolerance||Math.abs(e.top+e.height-i.top-i.height)<=this._followOfTolerance&&Math.abs(e.left+e.width-i.left-i.width)<=this._followOfTolerance){this.oPopup._applyPosition(this.oPopup._oLastPosition,true)}else{this.close()}},this);this.setFollowOf(true);this._initResponsivePaddingsEnablement();this._oRestoreFocusDelegate={onBeforeRendering:function(){var t=v(document.activeElement),e=t.control(0);this._sFocusControlId=e&&e.getId()},onAfterRendering:function(){if(this._sFocusControlId&&!m(this.getDomRef(),document.activeElement)){sap.ui.getCore().byId(this._sFocusControlId).focus()}}};var t=this;this.oPopup._applyPosition=function(e,i){var o=this.getOpenState(),r;if(o===O.CLOSING||o===O.CLOSED){return}if(i){t._storeScrollPosition()}t._clearCSSStyles();var s=t._placements.indexOf(t.getPlacement());if(s>3&&!t._bPosCalced){t._calcPlacement();return}t._bPosCalced=false;if(t._oOpenBy instanceof u){e.of=t._getOpenByDomRef()}if(!e.of){C.warning("sap.m.Popover: in function applyPosition, the openBy element doesn't have any DOM output. "+t);return}if(!m(document.documentElement,e.of)&&e.of.id){r=v(document.getElementById(e.of.id));if(r){e.of=r}else{C.warning("sap.m.Popover: in function applyPosition, the openBy element's DOM is already detached from DOM tree and can't be found again by the same id. "+t);return}}var n=v(e.of).rect();if(i&&t._$window.height()==t._initialWindowDimensions.height&&(n.top+n.height<=0||n.top>=t._$window.height()||n.left+n.width<=0||n.left>=t._$window.width())){t.close();return}var l=t.getDomRef("scroll");if(!f.system.desktop){v(window).scrollLeft(0)}t._deregisterContentResizeHandler();a.prototype._applyPosition.call(this,e);t._fnAdjustPositionAndArrow();t._restoreScrollPosition();t._registerContentResizeHandler(l)};this.oPopup.close=function(e){var i=typeof e==="boolean";var o=t.oPopup.getOpenState();if(e!==true&&(this.touchEnabled||!this._isFocusInsidePopup())&&this.isOpen()&&!(o===O.CLOSED||o===O.CLOSING)){t.fireBeforeClose({openBy:t._oOpenBy})}t._deregisterContentResizeHandler();a.prototype.close.apply(this,i?[]:arguments);t.removeDelegate(t._oRestoreFocusDelegate)}};B.prototype.onBeforeRendering=function(){var t,e;if(!this._initialWindowDimensions.width||!this._initialWindowDimensions.height){this._initialWindowDimensions={width:this._$window.width(),height:this._$window.height()}}if(!this.getHorizontalScrolling()&&!this.getVerticalScrolling()){this._forceDisableScrolling=true}else if(!this._bVScrollingEnabled&&!this._bHScrollingEnabled&&this._hasSingleScrollableContent()){this._forceDisableScrolling=true;C.info("VerticalScrolling and horizontalScrolling in sap.m.Popover with ID "+this.getId()+" has been disabled because there's scrollable content inside")}else{this._forceDisableScrolling=false}if(!this._forceDisableScrolling){if(!this._oScroller){this._oScroller=new l(this,this.getId()+"-scroll",{horizontal:this.getHorizontalScrolling(),vertical:this.getVerticalScrolling()})}}if(this._bContentChanged){this._bContentChanged=false;t=this._getSingleNavContent();e=this._getSinglePageContent();if(t&&!this.getModal()&&!f.system.phone&&!v.sap.simulateMobileOnDesktop){t.attachEvent("afterNavigate",function(t){var e=this.getDomRef();if(e){var i=this.$().firstFocusableDomRef()||e;i.focus()}},this)}if(t||e){e=e||t.getCurrentPage();if(e&&e._getAnyHeader){this.addStyleClass("sapMPopoverWithHeaderCont")}if(t){t.attachEvent("navigate",function(t){var e=t.getParameter("to");if(e instanceof n&&e.isA("sap.m.Page")){this.$().toggleClass("sapMPopoverWithHeaderCont",!!e._getAnyHeader())}},this)}}}};B.prototype.onAfterRendering=function(){var t,e,i;if(!this._marginTopInit&&this.getShowArrow()){this._marginTop=2;if(this._oOpenBy){t=v(this._getOpenByDomRef());if(!(t.closest("header.sapMIBar").length>0)){e=t.closest(".sapMPage");if(e.length>0){i=e.children("header.sapMIBar");if(i.length>0){this._marginTop+=i.outerHeight()}}}this._marginTopInit=true}}};B.prototype.exit=function(){this._deregisterContentResizeHandler();f.resize.detachHandler(this._fnOrientationChange);i.removePopoverInstance(this);this.removeDelegate(this._oRestoreFocusDelegate);this._oRestoreFocusDelegate=null;if(this.oPopup){this.oPopup.detachClosed(this._handleClosed,this);this.oPopup.destroy();this.oPopup=null}if(this._oScroller){this._oScroller.destroy();this._oScroller=null}if(this._internalHeader){this._internalHeader.destroy();this._internalHeader=null}if(this._headerTitle){this._headerTitle.destroy();this._headerTitle=null}};B.prototype.openBy=function(t,e){var r=this.oPopup,s=this.oPopup.getOpenState(),n=this._getInitialFocusId(),l,p,g,c;l=t.getDomRef&&t.getDomRef()||t;c=v(l).closest(".sapUiSizeCompact");g=h.get("_sap_m_Popover_ForceCompactArrowOffset")==="true";this._bSizeCompact=o._bSizeCompact||!!c.length||this.hasStyleClass("sapUiSizeCompact");this._bUseCompactArrow=this._bSizeCompact||g;this._adaptPositionParams();if(s===O.OPEN||s===O.OPENING){if(this._oOpenBy===t){return this}else{var u=function(){r.detachClosed(u,this);this.openBy(t)};r.attachClosed(u,this);this.close();return this}}if(!t){return this}if(f.support.touch){f.resize.attachHandler(this._fnOrientationChange)}if(!this._oOpenBy||t!==this._oOpenBy){this._oOpenBy=t}this.fireBeforeOpen({openBy:this._oOpenBy});r.attachOpened(this._handleOpened,this);r.attachClosed(this._handleClosed,this);r.setInitialFocusId(n);p=this._placements.indexOf(this.getPlacement());if(p>-1){l=this._getOpenByDomRef();if(!l){C.error("sap.m.Popover id = "+this.getId()+": is opened by a control which isn't rendered yet.");return this}r.setAutoCloseAreas([t]);r.setContent(this);if(p<=3){r.setPosition(this._myPositions[p],this._atPositions[p],l,this._calcOffset(this._offsets[p]),"fit")}else{r._oPosition.of=l}var d=this;var _=function(){if(r.bIsDestroyed){return}if(r.getOpenState()===O.CLOSING){if(d._sOpenTimeout){clearTimeout(d._sOpenTimeout);d._sOpenTimeout=null}d._sOpenTimeout=setTimeout(_,150)}else{d._oPreviousFocus=a.getCurrentFocusInfo();r.open();d.addDelegate(d._oRestoreFocusDelegate,d);if(!e){i.addPopoverInstance(d)}}};_()}else{C.error(this.getPlacement()+"is not a valid value! It can only be top, right, bottom or left")}return this};B.prototype.close=function(){var t=this.oPopup.getOpenState(),e,i;if(t===O.CLOSED||t===O.CLOSING){return this}this.fireBeforeClose({openBy:this._oOpenBy});this.oPopup.close(true);if(this._oPreviousFocus){i=document.activeElement||{};e=this._oPreviousFocus.sFocusId===sap.ui.getCore().getCurrentFocusedControlId()||this._oPreviousFocus.sFocusId===i.id;if(!e){a.applyFocusInfo(this._oPreviousFocus);this._oPreviousFocus=null}}return this};B.prototype.isOpen=function(){return this.oPopup&&this.oPopup.isOpen()};B.prototype.setFollowOf=function(t){if(t){this.oPopup.setFollowOf(this._fnFollowOf)}else{this.oPopup.setFollowOf(false)}return this};B.prototype._clearCSSStyles=function(){var t=this.getDomRef().style,e=this.$("cont"),i=e.children(".sapMPopoverScroll"),o=e[0].style,r=i[0].style,s=this.getContentWidth(),n=this.getContentHeight(),a=this.$("arrow"),l,h;if(s.indexOf("%")>0){l=this._$window.width();s=w.calcPercentageSize(s,l)}if(n.indexOf("%")>0){h=this._$window.height();n=w.calcPercentageSize(n,h)}o.width=s||"";o.height=n||"";o.maxWidth="";o.maxHeight="";t.left="";t.right="";t.top="";t.bottom="";t.width="";t.height="";t.overflow="";r.width="";r.display="";a.removeClass("sapMPopoverArrRight sapMPopoverArrLeft sapMPopoverArrDown sapMPopoverArrUp sapMPopoverCrossArr sapMPopoverFooterAlignArr sapMPopoverHeaderAlignArr sapContrast sapContrastPlus");a.css({left:"",top:""})};B.prototype._onOrientationChange=function(){var t=this.oPopup.getOpenState();if(!(t===O.OPEN||t===O.OPENING)){return}this.oPopup._applyPosition(this.oPopup._oLastPosition,true);this._includeScrollWidth()};B.prototype._includeScrollWidth=function(){var t=this.getContentWidth(),e=this.$(),i=Math.floor(window.innerWidth*.9),o=this.$("cont");if(!o[0]){return}if(f.system.desktop&&!f.browser.chrome){var r=o[0].clientHeight<o[0].scrollHeight;if(r&&(!t||t==="auto")&&o.width()<i){e.addClass("sapMPopoverVerticalScrollIncluded")}else{e.removeClass("sapMPopoverVerticalScrollIncluded")}}};B.prototype._handleOpened=function(){var t=this;this.oPopup.detachOpened(this._handleOpened,this);if(!f.support.touch){setTimeout(function(){!t.bIsDestroyed&&f.resize.attachHandler(t._fnOrientationChange)},0)}var e=this._getInitialFocusId(),i=sap.ui.getCore().byId(e),o=e?window.document.getElementById(e):null;if(i&&i.getFocusDomRef()){i.getFocusDomRef().focus()}else if(!i&&o){o.focus()}this.fireAfterOpen({openBy:this._oOpenBy})};B.prototype._handleClosed=function(){this.oPopup.detachClosed(this._handleClosed,this);f.resize.detachHandler(this._fnOrientationChange);i.removePopoverInstance(this);if(!this.oPopup._bModal&&!f.system.desktop&&document.activeElement&&!v(document.activeElement).is(":visible")){document.activeElement.blur()}this.fireAfterClose({openBy:this._oOpenBy})};B.prototype.onfocusin=function(t){var e=t.target,i=this.$();if(e.id===this.getId()+"-firstfe"){var o=i.lastFocusableDomRef();if(o){o.focus()}}else if(e.id===this.getId()+"-lastfe"){var r=i.firstFocusableDomRef();if(r){r.focus()}}};B.prototype.onkeydown=function(t){var e=y,i=t.which||t.keyCode,o=t.altKey;if(i===e.ESCAPE||o&&i===e.F4){if(t.originalEvent&&t.originalEvent._sapui_handledByControl){return}this.close();t.stopPropagation();t.preventDefault()}};B.prototype.onmousedown=function(t){var e=sap.ui.getCore().getConfiguration().getRTL();if(!t.target.classList.contains("sapMPopoverResizeHandle")){return}var i=v(document);var o=this.$();var r=this;o.addClass("sapMPopoverResizing");t.preventDefault();t.stopPropagation();var s={x:t.pageX,y:t.pageY,width:o.width(),height:o.height()};i.on("mousemove.sapMPopover",function(t){var i,o;if(e){i=s.width+s.x-t.pageX;o=s.height+(s.y-t.pageY)}else{i=s.width+t.pageX-s.x;o=s.height+(s.y-t.pageY)}r.setContentWidth(Math.max(i,r._minDimensions.width)+"px");r.setContentHeight(Math.max(o,r._minDimensions.height)+"px")});i.on("mouseup.sapMPopover",function(){o.removeClass("sapMPopoverResizing");i.off("mouseup.sapMPopover, mousemove.sapMPopover")})};B.prototype._hasSingleNavContent=function(){return!!this._getSingleNavContent()};B.prototype._getSingleNavContent=function(){var t=this._getAllContent();while(t.length===1&&t[0]instanceof n&&t[0].isA("sap.ui.core.mvc.View")){t=t[0].getContent()}if(t.length===1&&t[0]instanceof n&&t[0].isA("sap.m.NavContainer")){return t[0]}else{return null}};B.prototype._getSinglePageContent=function(){var t=this._getAllContent();while(t.length===1&&t[0]instanceof n&&t[0].isA("sap.ui.core.mvc.View")){t=t[0].getContent()}if(t.length===1&&t[0]instanceof n&&t[0].isA("sap.m.Page")){return t[0]}else{return null}};B.prototype._hasSinglePageContent=function(){var t=this._getAllContent();while(t.length===1&&t[0]instanceof n&&t[0].isA("sap.ui.core.mvc.View")){t=t[0].getContent()}if(t.length===1&&t[0]instanceof n&&t[0].isA("sap.m.Page")){return true}else{return false}};B.prototype._hasSingleScrollableContent=function(){var t=this._getAllContent();while(t.length===1&&t[0]instanceof n&&t[0].isA("sap.ui.core.mvc.View")){t=t[0].getContent()}if(t.length===1&&t[0]instanceof n&&t[0].isA(this._scrollContentList)){return true}return false};B.prototype._getOffsetX=function(){var t=this.getPlacement(),e=0;if(this._bHorizontalFlip){var i=this._getOpenByDomRef();var o=i!==undefined;var r=o?i.getBoundingClientRect().width:0;e=t===H.PreferredRightOrFlip?Math.abs(r):-Math.abs(r)}var s=sap.ui.getCore().getConfiguration().getRTL();var n=e*(s?-1:1)+this.getOffsetX()*(s?-1:1);return n};B.prototype._getOffsetY=function(){var t=this.getPlacement(),e=0;if(this._bVerticalFlip){var i=this._getOpenByDomRef();var o=i!==undefined;var r=o?i.getBoundingClientRect().height:0;e=t==="PreferredTopOrFlip"?-Math.abs(r):Math.abs(r)}return e+this.getOffsetY()};B.prototype._calcOffset=function(t){var e=this._getOffsetX(),i=this._getOffsetY();var o=t.split(" ");var t=parseInt(o[0])+e+" "+(parseInt(o[1])+i);return t};B.prototype._calcPlacement=function(){var t=this.getPlacement();var e=this._getOpenByDomRef();switch(t){case H.Auto:this._calcAuto();break;case H.Vertical:case H.VerticalPreferedTop:case H.VerticalPreferredTop:case H.VerticalPreferedBottom:case H.VerticalPreferredBottom:case H.PreferredTopOrFlip:case H.PreferredBottomOrFlip:this._calcVertical();break;case H.Horizontal:case H.HorizontalPreferedLeft:case H.HorizontalPreferredLeft:case H.HorizontalPreferedRight:case H.HorizontalPreferredRight:case H.PreferredRightOrFlip:case H.PreferredLeftOrFlip:this._calcHorizontal();break}this._bPosCalced=true;var i=this._placements.indexOf(this._oCalcedPos);this.oPopup.setPosition(this._myPositions[i],this._atPositions[i],e,this._calcOffset(this._offsets[i]),"fit")};B.prototype._getDocHeight=function(){var t=document.body,e=document.documentElement;return Math.max(t.scrollHeight,t.offsetHeight,e.clientHeight,e.offsetHeight)};B.prototype._calcVertical=function(){var t=v(this._getOpenByDomRef());var e=t[0]!==undefined;var i=this.getPlacement()===H.VerticalPreferedTop||this.getPlacement()===H.VerticalPreferredTop;var o=this.getPlacement()===H.VerticalPreferedBottom||this.getPlacement()===H.VerticalPreferredBottom;var r=this.getPlacement()===H.PreferredTopOrFlip;var s=this.getPlacement()===H.PreferredBottomOrFlip;var n=e?t[0].getBoundingClientRect().top:0;var a=e?t[0].getBoundingClientRect().height:0;var l=this._getOffsetY();var h=n-this._marginTop+l;var f=this.$().outerHeight();var p=this._getDocHeight()-(t.offset().top+a+this._marginBottom+l);if(i&&h>f+this._arrowOffset){this._bVerticalFlip=false;this._oCalcedPos=H.Top}else if(r){if(h>f+this._arrowOffset){this._bVerticalFlip=false;this._oCalcedPos=H.Top}else{this._bVerticalFlip=true;this._oCalcedPos=H.Bottom}}else if(o&&p>f+this._arrowOffset){this._oCalcedPos=H.Bottom;this._bVerticalFlip=false}else if(s){if(p>f+this._arrowOffset){this._bVerticalFlip=false;this._oCalcedPos=H.Bottom}else{this._bVerticalFlip=true;this._oCalcedPos=H.Top}}else if(h>p){this._oCalcedPos=H.Top}else{this._oCalcedPos=H.Bottom}};B.prototype._calcHorizontal=function(){var t=v(this._getOpenByDomRef());var e=t[0]!==undefined;var i=this.getPlacement()===H.HorizontalPreferedLeft||this.getPlacement()===H.HorizontalPreferredLeft;var o=this.getPlacement()===H.HorizontalPreferedRight||this.getPlacement()===H.HorizontalPreferredRight;var r=e?t[0].getBoundingClientRect().left:0;var s=e?t[0].getBoundingClientRect().width:0;var n=this._getOffsetX();var a=r-this._marginLeft+n;var l=r+s;var h=this._$window.width()-l-this._marginRight-n;var f=this.$().outerWidth();var p=this.getPlacement()===H.PreferredLeftOrFlip;var g=this.getPlacement()===H.PreferredRightOrFlip;var c=sap.ui.getCore().getConfiguration().getRTL();if(i&&a>f+this._arrowOffset){this._bHorizontalFlip=false;this._oCalcedPos=c?H.Right:H.Left}else if(p){if(a>f+this._arrowOffset){this._bHorizontalFlip=false;this._oCalcedPos=c?H.Right:H.Left}else{this._bHorizontalFlip=true;this._oCalcedPos=c?H.Left:H.Right}}else if(o&&h>f+this._arrowOffset){this._bHorizontalFlip=false;this._oCalcedPos=c?H.Left:H.Right}else if(g){if(h>f+this._arrowOffset){this._bHorizontalFlip=false;this._oCalcedPos=c?H.Left:H.Right}else{this._bHorizontalFlip=true;this._oCalcedPos=c?H.Right:H.Left}}else if(a>h){this._oCalcedPos=c?H.Right:H.Left}else{this._oCalcedPos=c?H.Left:H.Right}};B.prototype._calcAuto=function(){if(this._$window.width()>this._$window.height()){if(this._checkHorizontal()){this._calcHorizontal()}else if(this._checkVertical()){this._calcVertical()}else{this._calcBestPos()}}else{if(this._checkVertical()){this._calcVertical()}else if(this._checkHorizontal()){this._calcHorizontal()}else{this._calcBestPos()}}};B.prototype._checkHorizontal=function(){var t=v(this._getOpenByDomRef());var e=t[0]!==undefined;var i=e?t[0].getBoundingClientRect().left:0;var o=e?t[0].getBoundingClientRect().width:0;var r=this._getOffsetX();var s=i-this._marginLeft+r;var n=i+o;var a=this._$window.width()-n-this._marginRight-r;var l=this.$();var h=l.outerWidth()+this._arrowOffset;if(h<=s||h<=a){return true}};B.prototype._checkVertical=function(){var t=v(this._getOpenByDomRef());var e=t[0]!==undefined;var i=e?t[0].getBoundingClientRect().top:0;var o=e?t[0].getBoundingClientRect().height:0;var r=this._getOffsetY();var s=i-this._marginTop+r;var n=this._getDocHeight()-t.offset().top-o-this._marginBottom-r;var a=this.$();var l=a.outerHeight()+this._arrowOffset;if(l<=s||l<=n){return true}};B.prototype._calcBestPos=function(){var t=this.$();var e=t.outerHeight();var i=t.outerWidth();var o=sap.ui.getCore().getConfiguration().getRTL();var r=v(this._getOpenByDomRef());var s=r[0]!==undefined;var n=s?r[0].getBoundingClientRect().left:0;var a=s?r[0].getBoundingClientRect().top:0;var l=s?r[0].getBoundingClientRect().width:0;var h=s?r[0].getBoundingClientRect().height:0;var f=this._getOffsetX();var p=this._getOffsetY();var g=a-this._marginTop+p;var c=this._getDocHeight()-r.offset().top-h-this._marginBottom-p;var u=n-this._marginLeft+f;var d=n+l;var _=this._$window.width()-d-this._marginRight-f;var m=e*i;var P;var y;if(this._$window.height()-this._marginTop-this._marginBottom>=e){P=e}else{P=this._$window.height()-this._marginTop-this._marginBottom}if(this._$window.width()-this._marginLeft-this._marginRight>=i){y=i}else{y=this._$window.width()-this._marginLeft-this._marginRight}var C=P*u/m;var w=P*_/m;var O=y*g/m;var b=y*c/m;var B=Math.max(C,w);var S=Math.max(O,b);if(B>S){if(B===C){this._oCalcedPos=o?H.Right:H.Left}else if(B===w){this._oCalcedPos=o?H.Left:H.Right}}else if(S>B){if(S===O){this._oCalcedPos=H.Top}else if(S===b){this._oCalcedPos=H.Bottom}}else if(S===B){if(this._$window.height()>this._$window.width()){if(S===O){this._oCalcedPos=H.Top}else if(S===b){this._oCalcedPos=H.Bottom}}else{if(B===C){this._oCalcedPos=o?H.Right:H.Left}else if(B===w){this._oCalcedPos=o?H.Left:H.Right}}}};B.outerWidth=function(t,e){if(typeof window.SVGElement!=="undefined"&&t instanceof window.SVGElement){return t.getBoundingClientRect().width}return v(t).outerWidth(!!e)};B.outerHeight=function(t,e){if(typeof window.SVGElement!=="undefined"&&t instanceof window.SVGElement){return t.getBoundingClientRect().height}return v(t).outerHeight(!!e)};B.prototype._getPositionParams=function(t,e,i,o){var r=window.getComputedStyle(t[0]),s=window.getComputedStyle(i[0]),n=this.getDomRef().clientHeight!=this.getDomRef().scrollHeight?P().width:0,a={};a._$popover=t;a._$parent=v(this._getOpenByDomRef());a._$arrow=e;a._$content=i;a._$scrollArea=o;a._$header=t.children(".sapMPopoverHeader");a._$subHeader=t.children(".sapMPopoverSubHeader");a._$footer=t.children(".sapMPopoverFooter");a._fWindowTop=this._$window.scrollTop();a._fWindowRight=this._$window.width();a._fWindowBottom=B._bIOS7&&f.orientation.landscape&&window.innerHeight?window.innerHeight:this._$window.height();a._fWindowLeft=this._$window.scrollLeft();a._fDocumentWidth=a._fWindowLeft+a._fWindowRight;a._fDocumentHeight=a._fWindowTop+a._fWindowBottom;a._fArrowHeight=e.outerHeight(true);a._fWidth=B.outerWidth(t[0]);a._fWidthInner=a._$scrollArea?a._$scrollArea.width()+n:0;a._fHeight=B.outerHeight(t[0]);a._fHeaderHeight=a._$header.length>0?a._$header.outerHeight(true):0;a._fSubHeaderHeight=a._$subHeader.length>0?a._$subHeader.outerHeight(true):0;a._fFooterHeight=a._$footer.length>0?a._$footer.outerHeight(true):0;a._fOffset=t.offset();a._fOffsetX=this._getOffsetX();a._fOffsetY=this._getOffsetY();a._fMarginTop=a._fWindowTop+this._marginTop;a._fMarginRight=this._marginRight;a._fMarginBottom=this._marginBottom;a._fMarginLeft=a._fWindowLeft+this._marginLeft;a._fPopoverBorderTop=parseFloat(r.borderTopWidth);a._fPopoverBorderRight=parseFloat(r.borderRightWidth);a._fPopoverBorderBottom=parseFloat(r.borderBottomWidth);a._fPopoverBorderLeft=parseFloat(r.borderLeftWidth);a._fContentMarginTop=parseFloat(s.marginTop);a._fContentMarginBottom=parseFloat(s.marginBottom);return a};B.prototype._recalculateMargins=function(t,e){var i=sap.ui.getCore().getConfiguration().getRTL();switch(t){case H.Left:if(i){e._fMarginLeft=e._$parent.offset().left+B.outerWidth(e._$parent[0],false)+this._arrowOffset-e._fOffsetX}else{e._fMarginRight=e._fDocumentWidth-e._$parent.offset().left+this._arrowOffset-e._fOffsetX}break;case H.Right:if(i){e._fMarginRight=e._fDocumentWidth-B.outerWidth(e._$parent[0],false)-e._$parent.offset().left+this._arrowOffset}else{e._fMarginLeft=e._$parent.offset().left+B.outerWidth(e._$parent[0],false)+this._arrowOffset+e._fOffsetX}break;case H.Top:e._fMarginBottom=e._fDocumentHeight-e._$parent.offset().top+this._arrowOffset-e._fOffsetY;break;case H.Bottom:e._fMarginTop=e._$parent.offset().top+B.outerHeight(e._$parent[0],false)+this._arrowOffset+e._fOffsetY;break}};B.prototype._getPopoverPositionCss=function(t){var e,i,o,r,s=t._fDocumentWidth-t._fOffset.left-t._fWidth,n=t._fDocumentHeight-t._fOffset.top-t._fHeight,a=t._fDocumentWidth-t._fMarginRight-t._fMarginLeft<t._fWidth,l=t._fDocumentHeight-t._fMarginTop-t._fMarginBottom<t._fHeight,h=t._fOffset.left<t._fMarginLeft,f=this.getVerticalScrolling()&&t._fWidth!==t._fWidthInner?P().width:0,p=s<t._fMarginRight+f,g=t._fOffset.top<t._fMarginTop,c=n<t._fMarginBottom,u=sap.ui.getCore().getConfiguration().getRTL();if(a){e=t._fMarginLeft;i=t._fMarginRight}else{if(h){e=t._fMarginLeft;if(u){i=""}}else if(p){i=t._fMarginRight;e=""}}if(l){o=t._fMarginTop;r=t._fMarginBottom}else{if(g){o=t._fMarginTop}else if(c){r=t._fMarginBottom;o=""}}var d={top:o,bottom:r-t._fWindowTop,left:e,right:typeof i==="number"?i-t._fWindowLeft:i};return d};B.prototype._getContentDimensionsCss=function(t){var e={},i=t._$content.height(),o=this._getMaxContentWidth(t),r=this._getMaxContentHeight(t);r=Math.max(r,0);e["max-width"]=o+"px";if(this.getContentHeight()||i>r){e["height"]=Math.min(r,i)+"px"}else{e["height"]="";e["max-height"]=r+"px"}if(i>r&&this._hasSingleScrollableContent()){e["max-height"]=Math.min(r,i)+"px"}return e};B.prototype._getMaxContentWidth=function(t){return t._fDocumentWidth-t._fMarginLeft-t._fMarginRight-t._fPopoverBorderLeft-t._fPopoverBorderRight};B.prototype._getMaxContentHeight=function(t){return t._fDocumentHeight-t._fMarginTop-t._fMarginBottom-t._fHeaderHeight-t._fSubHeaderHeight-t._fFooterHeight-t._fContentMarginTop-t._fContentMarginBottom-t._fPopoverBorderTop-t._fPopoverBorderBottom};B.prototype._isHorizontalScrollbarNeeded=function(t){return this.getHorizontalScrolling()&&t._$scrollArea.outerWidth(true)<=t._$content.width()};B.prototype._getArrowOffsetCss=function(t,e){var i,o=sap.ui.getCore().getConfiguration().getRTL();e._fWidth=e._$popover.outerWidth();e._fHeight=e._$popover.outerHeight();if(t===H.Left||t===H.Right){i=e._$parent.offset().top-e._$popover.offset().top-e._fPopoverBorderTop+e._fOffsetY+.5*(B.outerHeight(e._$parent[0],false)-e._$arrow.outerHeight(false));i=Math.max(i,this._arrowOffsetThreshold);i=Math.min(i,e._fHeight-this._arrowOffsetThreshold-e._$arrow.outerHeight());return{top:i}}else if(t===H.Top||t===H.Bottom){if(o){i=e._$popover.offset().left+B.outerWidth(e._$popover[0],false)-(e._$parent.offset().left+B.outerWidth(e._$parent[0],false))+e._fPopoverBorderRight+e._fOffsetX+.5*(B.outerWidth(e._$parent[0],false)-e._$arrow.outerWidth(false));i=Math.max(i,this._arrowOffsetThreshold);i=Math.min(i,e._fWidth-this._arrowOffsetThreshold-e._$arrow.outerWidth(false));return{right:i}}else{i=e._$parent.offset().left-e._$popover.offset().left-e._fPopoverBorderLeft+e._fOffsetX+.5*(B.outerWidth(e._$parent[0],false)-e._$arrow.outerWidth(false));i=Math.max(i,this._arrowOffsetThreshold);i=Math.min(i,e._fWidth-this._arrowOffsetThreshold-e._$arrow.outerWidth(false));return{left:i}}}};B.prototype._getArrowPositionCssClass=function(t){switch(t){case H.Left:return"sapMPopoverArrRight";case H.Right:return"sapMPopoverArrLeft";case H.Top:return"sapMPopoverArrDown";case H.Bottom:return"sapMPopoverArrUp"}};B.prototype._getArrowStyleCssClass=function(t){var e=t._$arrow.position(),i=t._$footer.position(),o=this._getSingleNavContent(),r=this._getSinglePageContent(),s=0;if(o||r){r=r||o.getCurrentPage();if(r){s=r._getAnyHeader().$().outerHeight()}}if(e.top+t._fArrowHeight<t._fHeaderHeight+t._fSubHeaderHeight||e.top+t._fArrowHeight<s){return"sapMPopoverHeaderAlignArr"}else if(e.top<t._fHeaderHeight+t._fSubHeaderHeight||e.top<s||t._$footer.length&&e.top+t._fArrowHeight>i.top&&e.top<i.top){return"sapMPopoverCrossArr"}else if(t._$footer.length&&e.top>i.top){return"sapMPopoverFooterAlignArr"}};B.prototype._getCalculatedPlacement=function(){return this._oCalcedPos||this.getPlacement()};B.prototype._adjustPositionAndArrow=function(){var t=this.oPopup.getOpenState();if(!(t===O.OPEN||t===O.OPENING)){return}var e=this.$(),i=this.$("arrow"),o=this.$("cont"),r=this.$("scroll"),s=this._getCalculatedPlacement(),n=this._getPositionParams(e,i,o,r);this._recalculateMargins(s,n);var a=this._getPopoverPositionCss(n),l=this._getContentDimensionsCss(n),h=this._isHorizontalScrollbarNeeded(n);e.css(a);o.css(l);if(h){r.css("display","block")}if(this.getShowArrow()){var f=this._getArrowOffsetCss(s,n),p=this._getArrowPositionCssClass(s),g,c;i.removeAttr("style");i.css(f);i.addClass(p);if(s===H.Top&&n._$footer&&n._$footer.size()){c=true}if(s===H.Left||s===H.Right){g=this._getArrowStyleCssClass(n);if(g){i.addClass(g);if(g==="sapMPopoverFooterAlignArr"){c=true}}}if(c){i.addClass("sapContrast sapContrastPlus")}e.css("overflow","visible")}this._afterAdjustPositionAndArrowHook()};B.prototype._adaptPositionParams=function(){if(this.getShowArrow()){this._marginLeft=10;this._marginRight=10;this._marginBottom=10;this._arrowOffset=18;this._offsets=["0 -18","18 0","0 18","-18 0"];if(this._bUseCompactArrow){this._arrowOffset=9;this._offsets=["0 -9","9 0","0 9","-9 0"]}this._myPositions=["center bottom","begin center","center top","end center"];this._atPositions=["center top","end center","center bottom","begin center"]}else{this._marginTop=0;this._marginLeft=0;this._marginRight=0;this._marginBottom=0;this._arrowOffset=0;this._offsets=["0 0","0 0","0 0","0 0"];this._myPositions=["begin bottom","begin center","begin top","end center"];this._atPositions=["begin top","end center","begin bottom","begin center"]}};B.prototype._afterAdjustPositionAndArrowHook=function(){};B.prototype._isPopupElement=function(t){var e=this._getOpenByDomRef();return!!v(t).closest(sap.ui.getCore().getStaticAreaRef()).length||!!v(t).closest(e).length};B.prototype._getAnyHeader=function(){if(this.getCustomHeader()){return this.getCustomHeader()}else{if(this.getShowHeader()){this._createInternalHeader();return this._internalHeader}}};B.prototype._createInternalHeader=function(){if(!this._internalHeader){var e=this;this._internalHeader=new t(this.getId()+"-intHeader");this._setupBarTitleAlignment(this._internalHeader,this.getId()+"_internalHeader");this.setAggregation("_internalHeader",this._internalHeader);this._internalHeader.addEventDelegate({onAfterRendering:function(){e._restoreFocus()}});return true}else{return false}};B.prototype._animation=function(t,e){var i=null;var o=function(){e.off("webkitTransitionEnd transitionend");clearTimeout(i);setTimeout(function(){t()})};e.on("webkitTransitionEnd transitionend",o);i=setTimeout(o,this._getAnimationDuration())};B.prototype._getAnimationDuration=function(){return 300};B.prototype._openAnimation=function(t,e,i){var o=this;setTimeout(function(){t.css("display","block");o._includeScrollWidth();o._animation(function(){if(!o.oPopup||o.oPopup.getOpenState()!==O.OPENING){return}i()},t)},f.browser.firefox?50:0)};B.prototype._closeAnimation=function(t,e,i){t.addClass("sapMPopoverTransparent");this._animation(function(){i();t.removeClass("sapMPopoverTransparent")},t)};B.prototype._getInitialFocusId=function(){return this.getInitialFocus()||this._getFirstVisibleButtonId()||this._getFirstFocusableContentElementId()||this.getId()};B.prototype._getFirstVisibleButtonId=function(){var t=this.getBeginButton(),e=this.getEndButton(),i="";if(t&&t.getVisible()){i=t.getId()}else if(e&&e.getVisible()){i=e.getId()}return i};B.prototype._getFirstFocusableContentElementId=function(){var t="";var e=this.$("cont");var i=e.firstFocusableDomRef();if(i){t=i.id}return t};B.prototype._restoreFocus=function(){if(this.isOpen()){var t=this._getInitialFocusId(),e=sap.ui.getCore().byId(t),i=t?window.document.getElementById(t):null;if(e&&e.getFocusDomRef()){e.getFocusDomRef().focus()}else if(!e&&i){i.focus()}}};B.prototype._registerContentResizeHandler=function(t){if(!this._sResizeListenerId){this._sResizeListenerId=d.register(t||this.getDomRef("scroll"),this._fnOrientationChange)}};B.prototype._deregisterContentResizeHandler=function(){if(this._sResizeListenerId){d.deregister(this._sResizeListenerId);this._sResizeListenerId=null}};B.prototype._storeScrollPosition=function(){var t=this.$("cont");if(t.length>0){this._oScrollPosDesktop={x:t.scrollLeft(),y:t.scrollTop()}}};B.prototype._restoreScrollPosition=function(){if(!this._oScrollPosDesktop){return}var t=this.$("cont");if(t.length>0){t.scrollLeft(this._oScrollPosDesktop.x).scrollTop(this._oScrollPosDesktop.y);this._oScrollPosDesktop=null}};B.prototype._repositionOffset=function(){var t=this.oPopup.getOpenState(),e,i;if(!(t===O.OPEN)){return this}e=this.oPopup._oLastPosition;i=this._placements.indexOf(this.getPlacement());if(i===-1){return this}if(i<4){e.offset=this._calcOffset(this._offsets[i]);this.oPopup._applyPosition(e)}else{this._calcPlacement()}return this};B.prototype._getOpenByDomRef=function(){if(!this._oOpenBy){return null}if(this._oOpenBy instanceof u){return this._oOpenBy.getPopupAnchorDomRef&&this._oOpenBy.getPopupAnchorDomRef()||this._oOpenBy.getFocusDomRef()}else{return this._oOpenBy}};B.prototype._getAccessibilityOptions=function(){var t,e={},i=this._getAnyHeader();e.role="dialog";e.modal=this.getProperty("ariaModal");if(this.getShowHeader()&&i&&i.getVisible()){t=Array.prototype.concat(i.getId(),this.getAssociation("ariaLabelledBy",[]));e.labelledby=t.join(" ")}return e};B.prototype.setPlacement=function(t){this.setProperty("placement",t,true);this._bVerticalFlip=false;this._bHorizontalFlip=false;var e=this._placements.indexOf(t);if(e<=3){this._oCalcedPos=t}return this};B.prototype.setTitle=function(t){this.setProperty("title",t,true);if(this._headerTitle){this._headerTitle.setText(t)}else{this._headerTitle=new r(this.getId()+"-title",{text:this.getTitle(),level:"H2"});this._createInternalHeader();this._internalHeader.addContentMiddle(this._headerTitle)}return this};B.prototype.setBeginButton=function(t){var e=this.getBeginButton();if(e===t){return this}this._createInternalHeader();this._beginButton=t;if(t){if(e){this._internalHeader.removeAggregation("contentLeft",e,true)}this._internalHeader.addAggregation("contentLeft",t)}else{this._internalHeader.removeContentLeft(e)}return this};B.prototype.setEndButton=function(t){var e=this.getEndButton();if(e===t){return this}this._createInternalHeader();this._endButton=t;if(t){if(e){this._internalHeader.removeAggregation("contentRight",e,true)}this._internalHeader.insertAggregation("contentRight",t,1,true);this._internalHeader.invalidate()}else{this._internalHeader.removeContentRight(e)}return this};B.prototype.setLeftButton=function(t){if(!(t instanceof e)){t=sap.ui.getCore().byId(t)}this.setBeginButton(t);return this.setAssociation("leftButton",t)};B.prototype.setRightButton=function(t){if(!(t instanceof e)){t=sap.ui.getCore().byId(t)}this.setEndButton(t);return this.setAssociation("rightButton",t)};B.prototype.setShowHeader=function(t){if(t===this.getShowHeader()||this.getCustomHeader()){return this}if(t){if(this._internalHeader){this._internalHeader.$().show()}}else{if(this._internalHeader){this._internalHeader.$().hide()}}this.setProperty("showHeader",t,true);return this};B.prototype.setModal=function(t,e){if(t===this.getModal()){return this}this.oPopup.setModal(t,("sapMPopoverBLayer "+(e||"")).trim());this.setProperty("modal",t,true);return this};B.prototype.setOffsetX=function(t){this.setProperty("offsetX",t,true);return this._repositionOffset()};B.prototype.setOffsetY=function(t){this.setProperty("offsetY",t,true);return this._repositionOffset()};B.prototype.setEnableScrolling=function(t){this.setHorizontalScrolling(t);this.setVerticalScrolling(t);var e=this.getEnableScrolling();if(e===t){return this}this.setProperty("enableScrolling",t,true);return this};B.prototype.setVerticalScrolling=function(t){this._bVScrollingEnabled=t;var e=this.getVerticalScrolling();if(e===t){return this}this.$().toggleClass("sapMPopoverVerScrollDisabled",!t);this.setProperty("verticalScrolling",t,true);if(this._oScroller){this._oScroller.setVertical(t)}return this};B.prototype.setHorizontalScrolling=function(t){this._bHScrollingEnabled=t;var e=this.getHorizontalScrolling();if(e===t){return this}this.$().toggleClass("sapMPopoverHorScrollDisabled",!t);this.setProperty("horizontalScrolling",t,true);if(this._oScroller){this._oScroller.setHorizontal(t)}return this};B.prototype.setResizable=function(t){if(!f.system.desktop){t=false}return this.setProperty("resizable",t,true)};B.prototype._setAriaModal=function(t){return this.setProperty("ariaModal",t)};B.prototype.getScrollDelegate=function(){return this._oScroller};B.prototype.setAggregation=function(t,e,i){if(t==="beginButton"||t==="endButton"){var o="set"+t.charAt(0).toUpperCase()+t.slice(1);return this[o](e)}else{return n.prototype.setAggregation.apply(this,arguments)}};B.prototype.getAggregation=function(t,e){if(t==="beginButton"||t==="endButton"){var i=this["_"+t];return i||e||null}else{return n.prototype.getAggregation.apply(this,arguments)}};B.prototype.destroyAggregation=function(t,e){var i=v(document.activeElement).control(0);if(t==="beginButton"||t==="endButton"){var o=this["_"+t];if(o){o.destroy();this["_"+t]=null}}else{n.prototype.destroyAggregation.apply(this,arguments)}i&&i.getDomRef()?i.focus():this.focus();return this};B.prototype.invalidate=function(t){if(this.isOpen()){n.prototype.invalidate.apply(this,arguments)}return this};B.prototype.addAggregation=function(t,e,i){if(t==="content"){this._bContentChanged=true}n.prototype.addAggregation.apply(this,arguments)};B.prototype._getAllContent=function(){return this.getContent()};B.prototype._applyContextualSettings=function(){p.prototype._applyContextualSettings.call(this,p._defaultContextualSettings)};s.mixInto(B.prototype);return B});