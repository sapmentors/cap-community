/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","sap/ui/core/Control","sap/ui/core/ResizeHandler","sap/ui/core/delegate/ItemNavigation","sap/ui/Device","sap/m/ActionSheet","./WizardProgressNavigatorRenderer","./Button","sap/ui/thirdparty/jquery"],function(t,e,i,r,s,a,o,n,p){"use strict";var h=e.extend("sap.m.WizardProgressNavigator",{metadata:{properties:{stepCount:{type:"int",group:"Data",defaultValue:3},stepTitles:{type:"string[]",group:"Appearance",defaultValue:[]},stepIcons:{type:"sap.ui.core.URI[]",group:"Appearance",defaultValue:[]},varyingStepCount:{type:"boolean",group:"Appearance",defaultValue:false}},events:{stepChanged:{parameters:{current:{type:"int"}}}}}});h.CONSTANTS={MINIMUM_STEPS:3,MAXIMUM_STEPS:8,MIN_STEP_WIDTH_NO_TITLE:64,MIN_STEP_WIDTH_WITH_TITLE:200};h.TEXT={SELECTED:"WIZARD_PROG_NAV_SELECTED",PROCESSED:"WIZARD_PROG_NAV_PROCESSED",STEP:"WIZARD_PROG_NAV_STEP_TITLE",OPTIONAL_STEP:"WIZARD_STEP_OPTIONAL_STEP_TEXT"};h.prototype.init=function(){this._iCurrentStep=1;this._iActiveStep=1;this._aCachedSteps=[];this._aStepOptionalIndication=[];this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._oActionSheet=new a;this._createAnchorNavigation()};h.prototype.onBeforeRendering=function(){if(this.getStepCount()!==this.getStepIcons().filter(String).length){this.setStepIcons([])}if(this.getStepCount()!==this.getStepTitles().filter(String).length){this.setStepTitles([])}};h.prototype.onAfterRendering=function(){var t,e=this._iActiveStep-1,r=this._iCurrentStep-1;this._cacheDOMElements();this._updateStepZIndex();this._updateAnchorNavigation(e);this._updateStepActiveAttribute(e);this._removeAnchorAriaDisabledAttribute(e);this._updateStepCurrentAttribute(r);this._updateAnchorAriaLabelAttribute(r);this._updateOpenSteps();i.register(this.getDomRef(),this._updateOpenSteps.bind(this));if(s.os.name===s.os.OS.IOS){t=this.$().find(".sapMWizardProgressNavStep").css("display","block");setTimeout(t["css"].bind(t,"display",""),0)}};h.prototype.ontap=function(t){if(this._isGroupAtStart(t.target)){return this._showActionSheet(t.target,true)}if(this._isGroupAtEnd(t.target)){return this._showActionSheet(t.target,false)}if(!this._isAnchor(t.target)||!this._isOpenStep(t.target)||!this._isActiveStep(this._getStepNumber(t.target))){return}this._updateCurrentStep(this._getStepNumber(t.target));this.fireStepChanged({current:this._getStepNumber(t.target)})};h.prototype.onsapspace=function(t){if(this._onEnter){this._onEnter(t,this._oAnchorNavigation.getFocusedIndex())}this.ontap(t)};h.prototype.onsapenter=h.prototype.onsapspace;h.prototype.exit=function(){i.deregisterAllForControl(this.getId());this.removeDelegate(this._oAnchorNavigation);this._oAnchorNavigation.destroy();this._oAnchorNavigation=null;this._oActionSheet.destroy();this._oActionSheet=null;this._iCurrentStep=null;this._iActiveStep=null;this._aCachedSteps=null;this._aStepOptionalIndication=null};h.prototype.getCurrentStep=function(){return this._iCurrentStep};h.prototype.getProgress=function(){return this._iActiveStep};h.prototype.previousStep=function(){var t=this.getCurrentStep();if(t<2){return this}return this._moveToStep(t-1)};h.prototype.nextStep=function(){return this._moveToStep(this.getCurrentStep()+1)};h.prototype.incrementProgress=function(){return this._moveToStep(this.getProgress()+1)};h.prototype.discardProgress=function(t){if(t<=0||t>this._iActiveStep){return this}this._updateCurrentStep(t,this._iCurrentStep);this._updateStepActiveAttribute(t-1,this._iActiveStep-1);this._addAnchorAriaDisabledAttribute(t-1);this._updateAnchorNavigation(t-1);this._iCurrentStep=t;this._iActiveStep=t};h.prototype._setOnEnter=function(t){this._onEnter=t};h.prototype._createAnchorNavigation=function(){var t=this;this._oAnchorNavigation=new r;this._oAnchorNavigation.setCycling(false);this._oAnchorNavigation.setDisabledModifiers({sapnext:["alt"],sapprevious:["alt"]});this._oAnchorNavigation.attachEvent("AfterFocus",function(e){var i=e.mParameters.oEvent;if(!i||!i.relatedTarget||p(i.relatedTarget).hasClass(o.CLASSES.ANCHOR)){return}t._oAnchorNavigation.focusItem(t._iCurrentStep-1)});this.addDelegate(this._oAnchorNavigation)};h.prototype._cacheDOMElements=function(){var t=this.getDomRef();this._aCachedSteps=t.querySelectorAll("."+o.CLASSES.STEP)};h.prototype._updateStepZIndex=function(){var t=this._iCurrentStep-1,e=this._aCachedSteps.length,i=h.CONSTANTS.MAXIMUM_STEPS;for(var r=0;r<e;r++){if(r<=t){this._aCachedSteps[r].style.zIndex=0}else{this._aCachedSteps[r].style.zIndex=i;i-=1}}};h.prototype._updateAnchorNavigation=function(t){var e=this.getDomRef(),i=[];for(var r=0;r<=t;r++){if(this._aCachedSteps[r]){i.push(this._aCachedSteps[r].children[0])}}this._oAnchorNavigation.setRootDomRef(e);this._oAnchorNavigation.setItemDomRefs(i);this._oAnchorNavigation.setPageSize(t);this._oAnchorNavigation.setFocusedIndex(t)};h.prototype._updateStepActiveAttribute=function(t,e){if(e!==undefined&&this._aCachedSteps[e]){this._aCachedSteps[e].removeAttribute(o.ATTRIBUTES.ACTIVE_STEP)}if(this._aCachedSteps[t]){this._aCachedSteps[t].setAttribute(o.ATTRIBUTES.ACTIVE_STEP,true)}};h.prototype._updateStepCurrentAttribute=function(t,e){if(e!==undefined&&this._aCachedSteps[e]){this._aCachedSteps[e].removeAttribute(o.ATTRIBUTES.CURRENT_STEP)}if(this._aCachedSteps[t]){this._aCachedSteps[t].setAttribute(o.ATTRIBUTES.CURRENT_STEP,true)}};h.prototype._addAnchorAriaDisabledAttribute=function(t){var e=this._aCachedSteps.length,i;for(var r=t+1;r<e;r++){i=this._aCachedSteps[r].children[0];i.setAttribute(o.ATTRIBUTES.ARIA_DISABLED,true);i.removeAttribute(o.ATTRIBUTES.ARIA_LABEL)}};h.prototype._removeAnchorAriaDisabledAttribute=function(t){if(this._aCachedSteps[t]){this._aCachedSteps[t].children[0].removeAttribute(o.ATTRIBUTES.ARIA_DISABLED)}};h.prototype._updateAnchorAriaLabelAttribute=function(t,e){if(e!==undefined&&this._aCachedSteps[e]){this._aCachedSteps[e].children[0].setAttribute(o.ATTRIBUTES.ARIA_LABEL,this._oResourceBundle.getText(h.TEXT.PROCESSED))}if(this._aCachedSteps[t]){this._aCachedSteps[t].children[0].setAttribute(o.ATTRIBUTES.ARIA_LABEL,this._oResourceBundle.getText(h.TEXT.SELECTED))}};h.prototype._moveToStep=function(t){var e=this.getStepCount(),i=this.getCurrentStep();if(t>e){return this}if(t>this._iActiveStep){this._updateActiveStep(t)}return this._updateCurrentStep(t,i)};h.prototype._updateActiveStep=function(t,e){var i=t-1,r=(e||this._iActiveStep)-1;this._iActiveStep=t;this._updateAnchorNavigation(i);this._removeAnchorAriaDisabledAttribute(i);this._updateStepActiveAttribute(i,r)};h.prototype._updateCurrentStep=function(t,e){var i=t-1,r=(e||this.getCurrentStep())-1;this._iCurrentStep=t;this._updateStepZIndex();this._updateOpenSteps();this._updateStepCurrentAttribute(i,r);this._updateAnchorAriaLabelAttribute(i,r);return this};h.prototype._updateOpenSteps=function(){var t=this.$().width(),e=this._iCurrentStep-1,i=0,r=true,s=this.getStepTitles().length?Math.floor(t/h.CONSTANTS.MIN_STEP_WIDTH_WITH_TITLE):Math.floor(t/h.CONSTANTS.MIN_STEP_WIDTH_NO_TITLE);[].forEach.call(this._aCachedSteps,function(t){t.setAttribute(o.ATTRIBUTES.OPEN_STEP,false);t.setAttribute(o.ATTRIBUTES.OPEN_STEP_PREV,false);t.setAttribute(o.ATTRIBUTES.OPEN_STEP_NEXT,false)});if(this._aCachedSteps[e]){this._aCachedSteps[e].setAttribute(o.ATTRIBUTES.OPEN_STEP,true)}for(var a=1;a<s;a++){if(r){i+=1}if(r&&this._aCachedSteps[e+i]){this._aCachedSteps[e+i].setAttribute(o.ATTRIBUTES.OPEN_STEP,true);r=!r}else if(!r&&this._aCachedSteps[e-i]){this._aCachedSteps[e-i].setAttribute(o.ATTRIBUTES.OPEN_STEP,true);r=!r}else if(this._aCachedSteps[e+i+1]){i+=1;this._aCachedSteps[e+i].setAttribute(o.ATTRIBUTES.OPEN_STEP,true);r=true}else if(this._aCachedSteps[e-i]){this._aCachedSteps[e-i].setAttribute(o.ATTRIBUTES.OPEN_STEP,true);i+=1;r=false}}for(a=0;a<this._aCachedSteps.length;a++){if(this._aCachedSteps[a].getAttribute(o.ATTRIBUTES.OPEN_STEP)=="true"&&this._aCachedSteps[a-1]&&this._aCachedSteps[a-1].getAttribute(o.ATTRIBUTES.OPEN_STEP)=="false"){this._aCachedSteps[a-1].setAttribute(o.ATTRIBUTES.OPEN_STEP_PREV,true)}if(this._aCachedSteps[a].getAttribute(o.ATTRIBUTES.OPEN_STEP)=="false"&&this._aCachedSteps[a-1]&&this._aCachedSteps[a-1].getAttribute(o.ATTRIBUTES.OPEN_STEP)=="true"){this._aCachedSteps[a].setAttribute(o.ATTRIBUTES.OPEN_STEP_NEXT,true);break}}};h.prototype._isGroupAtStart=function(t){var e=p(t).closest("."+o.CLASSES.STEP);var i=this._getStepNumber(e);return e.attr(o.ATTRIBUTES.OPEN_STEP_PREV)==="true"&&i>1};h.prototype._isGroupAtEnd=function(t){var e=p(t).closest("."+o.CLASSES.STEP);var i=this._getStepNumber(e);return e.attr(o.ATTRIBUTES.OPEN_STEP_NEXT)==="true"&&i<this._aCachedSteps.length};h.prototype._showActionSheet=function(t,e){var i=e?0:this._getStepNumber(t)-1;var r=e?this._getStepNumber(t):this._aCachedSteps.length;var s,a;this._oActionSheet.removeAllButtons();for(var o=i;o<r;o++){s=this.getStepIcons()[o];a=this._aCachedSteps[o].childNodes[0].getAttribute("title");this._oActionSheet.addButton(new n({width:"200px",text:a,icon:s,enabled:this._iActiveStep>=o+1,press:function(t){this._moveToStep(t);this.fireStepChanged({current:t})}.bind(this,o+1)}))}this._oActionSheet.openBy(t)};h.prototype._isAnchor=function(t){return t.className.indexOf(o.CLASSES.ANCHOR)!==-1};h.prototype._isOpenStep=function(t){var e=p(t).closest("."+o.CLASSES.STEP);return e.attr(o.ATTRIBUTES.OPEN_STEP)==="true"||e.attr(o.ATTRIBUTES.OPEN_STEP)==="false"&&e.attr(o.ATTRIBUTES.OPEN_STEP_PREV)==="true"||e.attr(o.ATTRIBUTES.OPEN_STEP)==="false"&&e.attr(o.ATTRIBUTES.OPEN_STEP_NEXT)==="true"};h.prototype._isActiveStep=function(t){return t<=this._iActiveStep};h.prototype._getStepNumber=function(t){var e=p(t).closest("."+o.CLASSES.STEP).attr(o.ATTRIBUTES.STEP);return parseInt(e)};return h});