/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ResponsivePopover","./Button","./Toolbar","./Bar","sap/ui/core/Control","sap/ui/core/IconPool","./semantic/SemanticPage","./Popover","./MessageView","sap/ui/Device","./MessagePopoverRenderer","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,t,o,s,i,n,r,a,p,l,g,u,c){"use strict";var h=i.extend("sap.m.MessagePopover",{metadata:{library:"sap.m",properties:{asyncDescriptionHandler:{type:"any",group:"Behavior",defaultValue:null},asyncURLHandler:{type:"any",group:"Behavior",defaultValue:null},placement:{type:"sap.m.VerticalPlacementType",group:"Behavior",defaultValue:"Vertical"},initiallyExpanded:{type:"boolean",group:"Behavior",defaultValue:true},groupItems:{type:"boolean",group:"Behavior",defaultValue:false}},defaultAggregation:"items",aggregations:{items:{type:"sap.m.MessageItem",altTypes:["sap.m.MessagePopoverItem"],multiple:true,singularName:"item"},headerButton:{type:"sap.m.Button",multiple:false,forwarding:{idSuffix:"-messageView",aggregation:"headerButton"}}},events:{afterOpen:{parameters:{openBy:{type:"sap.ui.core.Control"}}},afterClose:{parameters:{openBy:{type:"sap.ui.core.Control"}}},beforeOpen:{parameters:{openBy:{type:"sap.ui.core.Control"}}},beforeClose:{parameters:{openBy:{type:"sap.ui.core.Control"}}},itemSelect:{parameters:{item:{type:"sap.m.MessagePopoverItem"},messageTypeFilter:{type:"sap.ui.core.MessageType"}}},listSelect:{parameters:{messageTypeFilter:{type:"sap.ui.core.MessageType"}}},longtextLoaded:{},urlValidated:{},activeTitlePress:{parameters:{item:{type:"sap.m.MessageItem"}}}}}});function f(e){return e.charAt(0).toUpperCase()+e.slice(1)}var d="sapMMsgPopover",y="320px",_="440px",m={back:n.getIconURI("nav-back"),close:n.getIconURI("decline"),information:n.getIconURI("message-information"),warning:n.getIconURI("message-warning"),error:n.getIconURI("message-error"),success:n.getIconURI("message-success")},v=["asyncDescriptionHandler","asyncURLHandler"],P={asyncDescriptionHandler:function(e){var t=e.item.getLongtextUrl();if(t){c.ajax({type:"GET",url:t,success:function(t){e.item.setDescription(t);e.promise.resolve()},error:function(){var o="A request has failed for long text data. URL: "+t;u.error(o);e.promise.reject(o)}})}}};h.setDefaultHandlers=function(e){v.forEach(function(t){if(e.hasOwnProperty(t)){P[t]=e[t]}})};h.prototype.init=function(){var o=this;var s;this._oOpenByControl=null;this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._oMessageView=this._initMessageView();this._oMessageView.addEventDelegate({onBeforeRendering:function(){var e=o._oMessageView._oSegmentedButton.getVisible(),t=!o.getInitiallyExpanded()||e;o._oMessageView._oSegmentedButton.setVisible(t);o._oMessageView._listPage.setShowHeader(true)}});this._insertCloseBtn(this._oMessageView._oListHeader);this._insertCloseBtn(this._oMessageView._oDetailsHeader);this._oMessageView._oSegmentedButton.attachEvent("select",this._onSegButtonSelect,this);this._oPopover=new e(this.getId()+"-messagePopover",{showHeader:false,contentWidth:_,contentHeight:y,placement:this.getPlacement(),showCloseButton:false,verticalScrolling:false,horizontalScrolling:false,modal:false,afterOpen:function(e){o.fireAfterOpen({openBy:e.getParameter("openBy")})},afterClose:function(e){o._oMessageView._navContainer.backToTop();o.fireAfterClose({openBy:e.getParameter("openBy")})},beforeOpen:function(e){o.fireBeforeOpen({openBy:e.getParameter("openBy")})},beforeClose:function(e){o.fireBeforeClose({openBy:e.getParameter("openBy")})}}).addStyleClass(d);this._oPopover._setAriaModal(false);this._oPopover.addContent(this._oMessageView);this._oPopover.addAssociation("ariaLabelledBy",this.getId()+"-messageView-HeadingDescr",true);s=this._oPopover.getAggregation("_popup");s.oPopup.setAutoClose(false);s.addEventDelegate({onBeforeRendering:this.onBeforeRenderingPopover,onAfterRendering:this.onAfterRenderingPopover},this);if(l.system.phone){this._oPopover.setBeginButton(new t({text:this._oResourceBundle.getText("MESSAGEPOPOVER_CLOSE"),press:this.close.bind(this)}))}v.forEach(function(e){if(P.hasOwnProperty(e)){this["set"+f(e)](P[e])}},this)};h.prototype.onBeforeRendering=function(){if(this.getDependents().indexOf(this._oPopover)===-1){this.addDependent(this._oPopover)}};h.prototype.onBeforeRenderingPopover=function(){if(this._bItemsChanged){var e=this.getItems();var t=this;this._oMessageView.destroyItems();e.forEach(function(e){e._updateProperties(function(){t._bItemsChanged=true});this._oMessageView.addItem(e.clone("","",{cloneChildren:true,cloneBinding:true}))},this);this._bItemsChanged=false}this._setInitialFocus();if(this._oOpenByControl&&!this._oOpenByControl.getVisible()){this._oPopover.close()}};h.prototype.onAfterRenderingPopover=function(){if(this._oPopover._oControl._sFocusControlId){this._oPopover._oControl._sFocusControlId=null}};h.prototype.exit=function(){this._oResourceBundle=null;this._oOpenByControl=null;if(this._oMessageView){this._oMessageView.destroy();this._oMessageView=null}if(this._oPopover){this._oPopover.destroy();this._oPopover=null}};h.prototype.openBy=function(e){var t=this._oPopover.getAggregation("_popup"),i=e.getParent();this._oOpenByControl=e;if(t instanceof a){if(i instanceof o||i instanceof s||i instanceof r){t._minDimensions={width:400,height:128};t.setShowArrow(false);t.setResizable(true)}else{t.setShowArrow(true)}}if(this._oPopover){this._restoreExpansionDefaults();this._oPopover.openBy(e)}return this};h.prototype.close=function(){if(this._oPopover){this._oPopover.close()}return this};h.prototype.isOpen=function(){return this._oPopover.isOpen()};h.prototype.toggle=function(e){if(this.isOpen()){this.close()}else{this.openBy(e)}return this};h.prototype.setPlacement=function(e){this.setProperty("placement",e,true);this._oPopover.setPlacement(e);return this};h.prototype.getDomRef=function(e){return this._oPopover&&this._oPopover.getAggregation("_popup").getDomRef(e)};h.prototype._initMessageView=function(){var e=this,t;t=new p(this.getId()+"-messageView",{activeTitlePress:function(t){if(l.system.phone){e.close()}e.fireActiveTitlePress({item:t.getParameter("item")})},listSelect:function(t){e.fireListSelect({messageTypeFilter:t.getParameter("messageTypeFilter")})},itemSelect:function(t){e.fireItemSelect({messageTypeFilter:t.getParameter("messageTypeFilter"),item:t.getParameter("item")})},longtextLoaded:function(){e.fireLongtextLoaded()},urlValidated:function(){e.fireUrlValidated()}});t._makeAutomaticBinding=function(){var t=e.getItems();if(!e.getBindingInfo("items")&&!t.length){this._bindToMessageModel()}};return t};h.prototype._onSegButtonSelect=function(){if(this.isOpen()&&!this.getInitiallyExpanded()&&this._oPopover.hasStyleClass(d+"-init")){this._expandMsgPopover()}};h.prototype._restoreExpansionDefaults=function(){if(!this.getInitiallyExpanded()&&this.getItems().length!=1){this._collapseMsgPopover();this._oMessageView._oSegmentedButton.setSelectedButton("none")}else{this._expandMsgPopover()}};h.prototype._expandMsgPopover=function(){var e,t=y,e=this._oPopover.$("cont").css("height");if(this.getInitiallyExpanded()&&e!=="0px"){t=parseFloat(e)?e:t}this._oPopover.setContentHeight(t).removeStyleClass(d+"-init")};h.prototype._collapseMsgPopover=function(){this._oPopover.addStyleClass(d+"-init").setContentHeight("auto")};h.prototype._insertCloseBtn=function(e){var o=this._oResourceBundle.getText("MESSAGEPOPOVER_CLOSE"),s=new t({icon:m["close"],visible:!l.system.phone,tooltip:o,press:this.close.bind(this)}).addStyleClass(d+"CloseBtn");e.insertContent(s,3,true)};h.prototype._setInitialFocus=function(){if(this._oMessageView._isListPage()&&this.getInitiallyExpanded()){this._oPopover.setInitialFocus(this._oMessageView._oLists[this._sCurrentList||"all"])}};h.prototype.setAsyncDescriptionHandler=function(e){this.setProperty("asyncDescriptionHandler",e,true);this._oMessageView.setProperty("asyncDescriptionHandler",e,true);return this};h.prototype.setAsyncURLHandler=function(e){this.setProperty("asyncURLHandler",e,true);this._oMessageView.setProperty("asyncURLHandler",e,true);return this};h.prototype.setModel=function(e,t){this._oMessageView.setModel(e,t);return i.prototype.setModel.apply(this,arguments)};h.prototype.setGroupItems=function(e){this.setProperty("groupItems",e,false);this._oMessageView.setProperty("groupItems",e,false);return this};h.prototype.navigateBack=function(){this._oMessageView.navigateBack()};["invalidate","addStyleClass","removeStyleClass","toggleStyleClass","hasStyleClass","getBusyIndicatorDelay","setBusyIndicatorDelay","getVisible","setVisible","getBusy","setBusy"].forEach(function(e){h.prototype[e]=function(){if(this._oPopover&&this._oPopover[e]){var t=this._oPopover;var o=t[e].apply(t,arguments);return o===t?this:o}}});["setModel","bindAggregation","setAggregation","insertAggregation","addAggregation","removeAggregation","removeAllAggregation","destroyAggregation"].forEach(function(e){h.prototype["_"+e+"Old"]=h.prototype[e];h.prototype[e]=function(){var t=h.prototype["_"+e+"Old"].apply(this,arguments);this._bItemsChanged=true;if(this._oPopover){this._oPopover.invalidate()}if(["removeAggregation","removeAllAggregation"].indexOf(e)!==-1){return t}return this}});return h});