/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/changeHandler/ChangeHandlerMediator","sap/ui/fl/changeHandler/Base","sap/base/Log"],function(e,t,n){"use strict";var r={};var a="sap.ui.core.Title";var o="sap.m.Toolbar";var i="sap.m.Label";var l="sap.ui.comp.smartfield.SmartLabel";r.applyChange=function(r,c,d){var g=r.getDefinition();var v=r.getDependentControl("targetContainerHeader",d);var f=d.modifier;var p=d.appComponent;var s=function(e){return e&&e.content&&e.content.createFunction};var u=function(e,t){return e.content&&e.content.newFieldSelector&&e.content.newFieldIndex!==undefined&&e.content.bindingPath&&e.content.oDataServiceVersion&&!!s(t)};return e.getChangeHandlerSettings({scenario:"addODataFieldWithLabel",oDataServiceVersion:g.content&&g.content.oDataServiceVersion}).then(function(e){if(u(g,e)){var h=g.content;var b=h.newFieldSelector;var C=h.bindingPath;var S=h.newFieldIndex;var w=f.getAggregation(c,"content");var m=w.slice();var I=w.indexOf(v);var D=0;var y=0;var x,A;if(w.length===1||w.length===I+1){D=w.length}else{var F=0;for(F=I+1;F<w.length;F++){var H=f.getControlType(w[F]);if(H===i||H===l){if(y==S){D=F;break}y++}if(H===a||H===o){D=F;break}if(F===w.length-1){D=w.length}}}var P={appComponent:p,view:d.view,fieldSelector:b,bindingPath:C};if(f.bySelector(b,p)){return t.markAsNotApplicable("Control to be created already exists:"+b)}A=s(e);x=A(f,P);var V={};if(x.label&&x.control){V.label=f.getSelector(x.label,p)}V.control=f.getSelector(x.control,p);r.setRevertData(V);m.splice(D,0,x.label,x.control);f.removeAllAggregation(c,"content");for(var T=0;T<m.length;++T){f.insertAggregation(c,"content",m[T],T,d.view)}return true}else{n.error("Change does not contain sufficient information to be applied or ChangeHandlerMediator could not be retrieved: ["+g.layer+"]"+g.namespace+"/"+g.fileName+"."+g.fileType)}})};r.completeChangeContent=function(e,t,n){var r=n.appComponent;var a=n.view;var o=e.getDefinition();if(!o.content){o.content={}}if(t.parentId){var i=n.modifier.bySelector(t.parentId,r,a);var l=i.getTitle()||i.getToolbar();if(l){e.addDependentControl(l.getId(),"targetContainerHeader",n)}}else{throw new Error("oSpecificChangeInfo.parentId attribute required")}if(t.bindingPath){o.content.bindingPath=t.bindingPath}else{throw new Error("oSpecificChangeInfo.bindingPath attribute required")}if(t.newControlId){o.content.newFieldSelector=n.modifier.getSelector(t.newControlId,r)}else{throw new Error("oSpecificChangeInfo.newControlId attribute required")}if(t.index===undefined){throw new Error("oSpecificChangeInfo.targetIndex attribute required")}else{o.content.newFieldIndex=t.index}if(t.oDataServiceVersion===undefined){throw new Error("oSpecificChangeInfo.oDataServiceVersion attribute required")}else{o.content.oDataServiceVersion=t.oDataServiceVersion}};r.revertChange=function(e,t,n){var r=n.appComponent;var a=n.view;var o=n.modifier;var i=e.getRevertData();var l=o.bySelector(i.control,r,a);if(i.label){var c=o.bySelector(i.label,r,a);o.removeAggregation(t,"content",c);o.destroy(c)}o.removeAggregation(t,"content",l);o.destroy(l);e.resetRevertData();return true};return r},true);