/*
 * ! OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../json/JSONModel","sap/ui/base/ManagedObject","./XMLNodeUtils","sap/ui/core/util/reflection/XmlTreeModifier"],function(t,e,a,i){"use strict";var o=t.extend("sap.ui.model.base.XMLNodeAttributesModel",{constructor:function(e,a,i){this.oCallback=a;this.oNode=e;this.sContext=i;this.getMetadata();t.apply(this,[e])},evalMode:{simple:"",binding:"@binding",bindingStr:"@bindingStr",data:"@data",metaContext:"@metaContext"}});o.prototype.getMetadata=function(){if(!this.oMetadata){var t=this.oNode.namespaceURI,e=a.findControlClass(t,a.localName(this.oNode));this.oMetadata=e.getMetadata();this.mAggregations=this.oMetadata.getAllAggregations();this.mProperties=this.oMetadata.getAllProperties();this.mSpecialSettings=this.oMetadata._mAllSpecialSettings;this.mEvent=this.oMetadata.getAllEvents()}return this.oMetadata};o.prototype.getVisitor=function(){return this.oCallback};o.prototype.getProperty=function(t,a){t=t||"/";var i,o=t.length==0;var r=this.evalMode.simple;t=this.resolve(t,a);t=t.substring(1);var s=t.split("/");var n=s.indexOf("@data");var l=s.indexOf("@metaContext");if(n>-1){r=this.evalMode.data;s.splice(n,1)}else if(l>-1){var h=s.slice(0,l);var d=s.slice(l+1,s.length);var p=this._diveDeep(h,o,this.evalMode.metaContext);i=this._getAnnotation(d,p);return i}else{var g=s[s.length-1];if(g.startsWith("@")){s.splice(-1,1);r=g}}if(s[0]=="metadataContexts"){var f=this.oNode.getAttribute("metadataContexts");if(s.length==1){i=f}else{var u=e.bindingParser(f);switch(s[1]){case"model":i=u.model;break;case"data":s.splice(1,1);i=this._diveDeep(s,o,this.evalMode.data);break;default:i=f;break}}}else{i=this._diveDeep(s,o,r)}return i};o.prototype.getAggregation=o.prototype.getProperty;o.prototype.getSpecialSetting=o.prototype.getProperty;o.prototype.getEvent=o.prototype.getProperty;o.prototype._diveDeep=function(t,e,a){var i=this._getTopProperty(t[0],a);if(t.length>1){t.shift();for(var o=0;o<t.length;o++){if(i){i=i[t[o]]}}}return i};o.prototype._getTopProperty=function(t,o){var r=null;var s;if(t.length==0){return this.oNode}if(this.mProperties.hasOwnProperty(t)){s=this.mProperties[t];if(o===this.evalMode.simple){o=this.evalMode.data}if(!this.oNode.hasAttribute(t)){r=s.defaultValue}else{r=this.oNode.getAttribute(t)}}else if(this.mAggregations.hasOwnProperty(t)){if(this.oNode.hasAttribute(t)){r=this.oNode.getAttribute(t)}else{r=i.getAggregation(this.oNode,t)}}else if(!this.mSpecialSettings.hasOwnProperty(t)&&!this.mEvents.hasOwnProperty(t)){r=null}else{if(this.oNode.hasAttribute(t)){r=this.oNode.getAttribute(t)}}var n=e.bindingParser(r);switch(o){case this.evalMode.simple:break;case this.evalMode.binding:r=n;break;case this.evalMode.bindingStr:if(!n){r=""}break;case this.evalMode.metaContext:var l={};if(n){if(typeof n==="string"){n=e.bindingParser("{"+n+"}")}var h=this.oCallback.getSettings().models[n.model];if(h){l.metaModel=h.getMetaModel();if(l.metaModel&&l.metaModel.getMetaContext){l.metaContext=l.metaModel.getMetaContext(n.path);l.schema=l.metaModel.getProperty(l.metaContext.getPath())}}r=l}return r;case this.evalMode.data:if(n){var d=null;try{d=this.oCallback.getResult(r)}catch(t){}if(d){r=d}}break}if(r){if(s){var p=a.parseScalarType(s.type,r,t);if(!(typeof p==="object"&&p.path)){r=p}}}return r};o.prototype._getObject=function(t,e,a){t=this.resolve(t,e);var i,o=this.getProperty(t,e);if(Array.isArray(o)){var r=o;var s=function(e){return function(){return t+"/"+e}};for(i=0;i<r.length;i++){r[i].getPath=s(i)}return r}return o};o.prototype.getContextName=function(){return this.sContext};o.prototype._getAnnotation=function(t,e){var a=e.schema;var i=0;while(a&&t[i]){a=a[t[i]];i++}return a};return o});