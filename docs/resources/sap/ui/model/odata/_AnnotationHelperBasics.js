/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/base/BindingParser","sap/ui/performance/Measurement","sap/ui/thirdparty/jquery"],function(e,t,a,n){"use strict";var i="sap.ui.model.odata.AnnotationHelper",r=/[\\\{\}:]/,o,u=/^(\/dataServices\/schema\/\d+\/entityContainer\/\d+\/entitySet\/\d+)(?:\/|$)/,d=[i],s=i+"/followPath",p=/^(\/dataServices\/schema\/\d+\/(?:complex|entity)Type\/\d+)(?:\/|$)/,l={"Edm.Boolean":"sap.ui.model.odata.type.Boolean","Edm.Byte":"sap.ui.model.odata.type.Byte","Edm.Date":"sap.ui.model.odata.type.Date","Edm.DateTime":"sap.ui.model.odata.type.DateTime","Edm.DateTimeOffset":"sap.ui.model.odata.type.DateTimeOffset","Edm.Decimal":"sap.ui.model.odata.type.Decimal","Edm.Double":"sap.ui.model.odata.type.Double","Edm.Float":"sap.ui.model.odata.type.Single","Edm.Guid":"sap.ui.model.odata.type.Guid","Edm.Int16":"sap.ui.model.odata.type.Int16","Edm.Int32":"sap.ui.model.odata.type.Int32","Edm.Int64":"sap.ui.model.odata.type.Int64","Edm.SByte":"sap.ui.model.odata.type.SByte","Edm.Single":"sap.ui.model.odata.type.Single","Edm.String":"sap.ui.model.odata.type.String","Edm.Stream":"sap.ui.model.odata.type.Stream","Edm.Time":"sap.ui.model.odata.type.Time","Edm.TimeOfDay":"sap.ui.model.odata.type.TimeOfDay"};o={descend:function(e,t,a){var i=n.extend({},e);o.expectType(e,typeof t==="number"?"array":"object");i.path=e.path+"/"+t;i.value=e.value[t];if(a===true){i.asExpression=true}else if(a){o.expectType(i,a)}return i},error:function(t,a,n){a=t.path+": "+a;e.error(a,o.toErrorString(t.value),n||i);throw new SyntaxError(a)},expectType:function(e,t){var a,n=e.value;if(t==="array"){a=!Array.isArray(n)}else{a=typeof n!==t||n===null||Array.isArray(n)}if(a){o.error(e,"Expected "+t)}},followPath:function(e,t){var n,i,r,u,p=e.getModel(),l,f={associationSetEnd:undefined,navigationAfterMultiple:false,isMultiple:false,navigationProperties:[],resolvedPath:undefined},y,m;a.average(s,"",d);i=o.getPath(t);r=i!==undefined&&o.getStartingPoint(e,i);if(!r){a.end(s);return undefined}l=i.split("/");while(i&&l.length&&r){y=l[0];u=y.indexOf("@");if(u===0){r+="/"+y.slice(1);l.shift();continue}m=p.getObject(r);n=p.getODataAssociationEnd(m,y);if(n){f.associationSetEnd=p.getODataAssociationSetEnd(m,y);f.navigationProperties.push(y);if(f.isMultiple){f.navigationAfterMultiple=true}f.isMultiple=n.multiplicity==="*";r=p.getODataEntityType(n.type,true);l.shift();continue}r=p.getODataProperty(m,l,true)}f.resolvedPath=r;a.end(s);return f},getPath:function(e){if(e){if(e.hasOwnProperty("AnnotationPath")){return e.AnnotationPath}if(e.hasOwnProperty("Path")){return e.Path}if(e.hasOwnProperty("PropertyPath")){return e.PropertyPath}if(e.hasOwnProperty("NavigationPropertyPath")){return e.NavigationPropertyPath}}return undefined},getStartingPoint:function(e,t){var a,n=p.exec(e.getPath()),i;if(n){return n[1]}n=u.exec(e.getPath());if(n){if(!t){return n[1]}i=e.getModel();a=i.getObject(n[1]);return i.getODataEntityType(a.entityType,true)}return undefined},property:function(e,t,a){return o.descend(e,t,a).value},resultToString:function(e,a,n){var i=e.value;function u(t){var a,n,u;t=t&&!e.ignoreTypeInPath&&e.type;if(t||r.test(i)){u="{path:"+o.toJSON(i);if(t){u+=",type:'"+l[e.type]+"'";a=o.toJSON(e.constraints);if(a&&a!=="{}"){u+=",constraints:"+a}n=o.toJSON(e.formatOptions);if(n&&n!=="{}"){u+=",formatOptions:"+n}}return u+"}"}return"{"+i+"}"}function d(e){switch(e.type){case"Edm.Boolean":case"Edm.Double":case"Edm.Int32":return String(e.value);default:return o.toJSON(e.value)}}switch(e.result){case"binding":return(a?"$":"")+u(n);case"composite":if(a){throw new Error("Trying to embed a composite binding into an expression binding")}return i;case"constant":if(e.type==="edm:Null"){return a?"null":null}if(a){return d(e)}return typeof i==="string"?t.complexParser.escape(i):String(i);case"expression":return a?i:"{="+i+"}"}},toErrorString:function(e){var t;if(typeof e!=="function"){try{t=o.toJSON(e);if(t!==undefined&&t!=="null"){return t}}catch(e){}}return String(e)},toJSON:function(e){var t,a=false,n="",i,r;t=JSON.stringify(e);if(t===undefined){return undefined}for(i=0;i<t.length;i+=1){switch(r=t.charAt(i)){case"'":n+="\\'";break;case'"':if(a){n+=r;a=false}else{n+="'"}break;case"\\":if(a){n+="\\\\"}a=!a;break;default:if(a){n+="\\";a=false}n+=r}}return n}};return o},false);