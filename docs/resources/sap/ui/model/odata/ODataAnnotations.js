/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./AnnotationParser","sap/base/assert","sap/base/Log","sap/ui/Device","sap/ui/base/EventProvider","sap/ui/thirdparty/jquery"],function(t,e,a,o,s,r){"use strict";var n=s.extend("sap.ui.model.odata.ODataAnnotations",{constructor:function(t){s.apply(this,arguments);if(arguments.length!==1){if(typeof arguments[2]==="object"){t=arguments[2]}t.urls=arguments[0];t.metadata=arguments[1]}this.oMetadata=t.metadata;this.oAnnotations=t.annotationData?t.annotationData:{};this.bLoaded=false;this.bAsync=t&&t.async;this.xPath=null;this.oError=null;this.bValidXML=true;this.oRequestHandles=[];this.oLoadEvent=null;this.oFailedEvent=null;this.mCustomHeaders=t.headers?r.extend({},t.headers):{};if(t.urls){this.addUrl(t.urls);if(!this.bAsync){e(!r.isEmptyObject(this.oMetadata),"Metadata must be available for synchronous annotation loading");if(this.oError){a.error("OData annotations could not be loaded: "+this.oError.message)}}}},metadata:{publicMethods:["parse","getAnnotationsData","attachFailed","detachFailed","attachLoaded","detachLoaded"]}});n.prototype.getAnnotationsData=function(){return this.oAnnotations};n.prototype.isLoaded=function(){return this.bLoaded};n.prototype.isFailed=function(){return this.oError!==null};n.prototype.fireLoaded=function(t){this.fireEvent("loaded",t);return this};n.prototype.attachLoaded=function(t,e,a){this.attachEvent("loaded",t,e,a);return this};n.prototype.detachLoaded=function(t,e){this.detachEvent("loaded",t,e);return this};n.prototype.fireFailed=function(t){this.fireEvent("failed",t);return this};n.prototype.attachFailed=function(t,e,a){this.attachEvent("failed",t,e,a);return this};n.prototype.detachFailed=function(t,e){this.detachEvent("failed",t,e);return this};n.prototype.setHeaders=function(t){this.mCustomHeaders=r.extend({},t)};n.prototype._createXMLDocument=function(t,e){var s=null;if(typeof t==="string"){e=t;t=null}if(o.browser.msie){s=new ActiveXObject("Microsoft.XMLDOM");s.preserveWhiteSpace=true;if(e.indexOf(" xmlns:xml=")>-1){e=e.replace(' xmlns:xml="http://www.w3.org/XML/1998/namespace"',"").replace(" xmlns:xml='http://www.w3.org/XML/1998/namespace'","")}s.loadXML(e)}else if(t){s=t}else if(window.DOMParser){s=(new DOMParser).parseFromString(e,"application/xml")}else{a.fatal("The browser does not support XML parsing. Annotations are not available.")}return s};n.prototype._documentHasErrors=function(t){return t.getElementsByTagName("parsererror").length>0||t.parseError&&t.parseError.errorCode!==0};n.prototype._mergeAnnotationData=function(e,a){if(!this.oAnnotations){this.oAnnotations={}}t.merge(this.oAnnotations,e);this.bLoaded=true;if(!a){this.fireLoaded({annotations:e})}};n.prototype.setXML=function(e,a,o){var s={success:function(){},error:function(){},fireEvents:false};o=r.extend({},s,o);var n=this._createXMLDocument(e,a);var i=function(e){var a={xmlDoc:e};var s=t.parse(this.oMetadata,e);if(s){a.annotations=s;o.success(a);this._mergeAnnotationData(s,!o.fireEvents)}else{o.error(a);if(o.fireEvents){this.fireFailed(a)}}}.bind(this,n);if(this._documentHasErrors(n)){o.error({xmlDoc:n});return false}else{var l=this.oMetadata.getServiceMetadata();if(!l||r.isEmptyObject(l)){this.oMetadata.attachLoaded(i)}else{i()}return true}};n.prototype.addUrl=function(t){var e=this;var a=t;if(Array.isArray(t)&&t.length==0){return Promise.resolve({annotations:this.oAnnotations})}if(!Array.isArray(t)){a=[t]}return new Promise(function(t,o){var s=0;var r={annotations:null,success:[],fail:[]};var n=function(n){s++;if(n.type==="success"){r.success.push(n)}else{r.fail.push(n)}if(s===a.length){r.annotations=e.oAnnotations;if(r.success.length>0){var i={annotations:e.oAnnotations,results:r};e.fireLoaded(i)}if(r.success.length<a.length){var l=new Error("At least one annotation failed to load/parse/merge");l.annotations=r.annotations;l.success=r.success;l.fail=r.fail;o(l)}else{t(r)}}};var i=0;if(e.bAsync){var l=Promise.resolve();for(i=0;i<a.length;++i){var u=e._loadFromUrl.bind(e,a[i]);l=l.then(u,u).then(n,n)}}else{for(i=0;i<a.length;++i){e._loadFromUrl(a[i]).then(n,n)}}})};n.prototype._loadFromUrl=function(t){var e=this;return new Promise(function(a,o){var s={url:t,async:e.bAsync,headers:r.extend({},e.mCustomHeaders,{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()})};var n;var i=function(a,s){if(n&&n.bSuppressErrorHandlerCall){return}e.oError={type:"fail",url:t,message:s,statusCode:a.status,statusText:a.statusText,responseText:a.responseText};if(e.bAsync){e.oFailedEvent=setTimeout(e.fireFailed.bind(e,e.oError),0)}else{e.fireFailed(e.oError)}o(e.oError)};var l=function(o,s,r){e.setXML(r.responseXML,r.responseText,{success:function(e){a({type:"success",url:t,message:s,statusCode:r.status,statusText:r.statusText,responseText:r.responseText})},error:function(t){i(r,"Malformed XML document")},url:t})};r.ajax(s).done(l).fail(i)})};n.prototype.destroy=function(){for(var t=0;t<this.oRequestHandles.length;++t){if(this.oRequestHandles[t]){this.oRequestHandles[t].bSuppressErrorHandlerCall=true;this.oRequestHandles[t].abort();this.oRequestHandles[t]=null}}s.prototype.destroy.apply(this,arguments);if(this.oLoadEvent){clearTimeout(this.oLoadEvent)}if(this.oFailedEvent){clearTimeout(this.oFailedEvent)}};return n});