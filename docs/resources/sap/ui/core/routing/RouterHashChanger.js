/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./HashChangerBase","sap/base/Log"],function(e,t){"use strict";var h=e.extend("sap.ui.core.routing.RouterHashChanger",{constructor:function(t){if(!t||!t.parent){throw new Error("sap.ui.core.routing.RouterHashChanger can't be instantiated without a parent")}this.parent=t.parent;this.hash=t.hash||"";this.subHashMap=t.subHashMap;this.key=t.key||"";e.apply(this)}});h.InvalidHash=Object.create(null);h.prototype.init=function(){this.parent.init()};h.prototype._generatePrefixedKey=function(e){return this.key?this.key+"-"+e:e};h.prototype.createSubHashChanger=function(e){this.children=this.children||{};var t=this._generatePrefixedKey(e);if(this.children[t]){return this.children[t]}var i=new h({key:t,parent:this,subHashMap:this.subHashMap,hash:this.subHashMap&&this.subHashMap[t]||""});i.attachEvent("hashSet",this._onChildHashChanged.bind(this,t));i.attachEvent("hashReplaced",this._onChildHashChanged.bind(this,t));this.children[t]=i;return i};h.prototype.fireHashChanged=function(e,t,h){var i,s=this.hash;this.hash=e;this.subHashMap=t;if(!h&&e!==s){this.fireEvent("hashChanged",{newHash:e,oldHash:s})}if(this.children){i=Object.keys(this.children);i.forEach(function(e){var i=t[e]===undefined?"":t[e];this.children[e].fireHashChanged(i,t,h)}.bind(this))}};h.prototype._onChildHashChanged=function(e,t){var h=t.getParameter("key")||e,i=t.getParameter("hash"),s=t.getParameter("nestedHashInfo"),n=t.getParameter("deletePrefix");if(this._bCollectMode){this._collectHash(h,i,n)}else{this.fireEvent(t.getId(),{hash:i,key:h,nestedHashInfo:s,deletePrefix:n})}};h.prototype._collectHash=function(e,t,h){this._aCollectedHashInfo=this._aCollectedHashInfo||[];this._aCollectedHashInfo.push({key:e,hash:t,deletePrefix:h})};h.prototype._hasRouterAttached=function(){return this.hasListeners("hashChanged")};h.prototype._collectActiveDescendantPrefix=function(){if(this.children){var e=Object.keys(this.children);return e.reduce(function(e,t){var h=this.children[t];if(h._hasRouterAttached()){e.push(t);Array.prototype.push.apply(e,h._collectActiveDescendantPrefix())}return e}.bind(this),[])}else{return[]}};h.prototype.getHash=function(){if(this._isUnderCollectMode()){return h.InvalidHash}else{return this.hash}};h.prototype.resetHash=function(){this.hash=undefined;return this};h.prototype.setHash=function(e,t,h){if(!(t instanceof Promise)){h=t;t=null}return this._modifyHash(e,t,h)};h.prototype.replaceHash=function(e,t,h){if(!(t instanceof Promise)){h=t;t=null}return this._modifyHash(e,t,h,true)};h.prototype._modifyHash=function(e,t,h,i){var s,n=i?"hashReplaced":"hashSet",r=this;if(!h){s=this._collectActiveDescendantPrefix()}if(t){this._bCollectMode=true;return t.then(function(){r.fireEvent(n,{hash:e,nestedHashInfo:r._aCollectedHashInfo,deletePrefix:s});r._aCollectedHashInfo=null;r._bCollectMode=false})}else{this.fireEvent(n,{hash:e,deletePrefix:s})}};h.prototype._isUnderCollectMode=function(){return this.parent instanceof h&&this.parent._isInCollectMode()};h.prototype._isInCollectMode=function(){return this._bCollectMode||this.parent instanceof h&&this.parent._isInCollectMode()};h.prototype.destroy=function(){this.parent.deregisterRouterHashChanger(this);if(this.children){Object.keys(this.children).forEach(function(e){var t=this.children[e];t.destroy()}.bind(this));delete this.children}delete this.hash;delete this.subHashMap;delete this.parent;delete this.key;e.prototype.destroy.apply(this,arguments)};h.prototype.deregisterRouterHashChanger=function(e){if(this.children){Object.keys(this.children).some(function(t){var h=this.children[t];if(h===e){delete this.children[t];return true}}.bind(this))}};return h});